<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pagamentos - PONTAZO BANK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Biblioteca de Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>
    <!-- Biblioteca do Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 40; animation: fadeIn 0.3s ease-out; }
        .modal-content { transform: translateY(-50px); animation: slideIn 0.3s ease-out forwards; max-height: 90vh; overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .status-badge, .priority-badge, .tag-badge { padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-pago { background-color: rgba(16, 185, 129, 0.1); color: #10B981; }
        .status-pendente { background-color: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .priority-alta { background-color: rgba(239, 68, 68, 0.2); color: #f87171; }
        .priority-media { background-color: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .priority-baixa { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .tag-badge { margin: 2px; display: inline-block; }
        .text-overdue { color: #ef4444; font-weight: 700; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab-btn { padding: 0.75rem 1.5rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-weight: 600; color: #94a3b8; }
        .tab-btn.active { color: #22d3ee; border-bottom-color: #22d3ee; }
        .tab-btn:hover { color: #e2e8f0; }
        .chart-container { background-color: #1e293b; padding: 1.5rem; border-radius: 1rem; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); height: 400px; }
        .filter-select, .search-input { background-color: #1e293b; border: 1px solid #334155; color: #e2e8f0; border-radius: 0.5rem; padding: 0.5rem 1rem; }
        .notification-bell { position: relative; cursor: pointer; }
        .notification-badge { position: absolute; top: -5px; right: -8px; background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .notification-dropdown { display: none; position: absolute; top: 100%; right: 0; background-color: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; width: 300px; max-height: 400px; overflow-y: auto; z-index: 50; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .loading-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay"><div class="loader"></div></div>

    <!-- Tela de Login -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white">PONTAZO <span class="text-cyan-400">BANK</span></h1>
                <p class="text-slate-400 mt-2">Acesso ao Sistema Financeiro</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-bold text-slate-300 mb-2">Utilizador</label>
                    <input type="text" id="username" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-bold text-slate-300 mb-2">Senha</label>
                    <input type="password" id="password" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                </div>
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Entrar</button>
                <p id="login-error" class="text-red-500 text-center mt-4 h-4"></p>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação (inicialmente oculto) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <!-- Cabeçalho -->
            <header class="flex justify-between items-center mb-8">
                <div class="w-1/3"></div>
                <div class="w-1/3 text-center">
                    <h1 class="text-4xl md:text-5xl font-bold text-white">PONTAZO <span class="text-cyan-400">BANK</span></h1>
                    <p class="text-lg text-slate-400 mt-2">Seu controle financeiro, simplificado.</p>
                </div>
                <div class="w-1/3 flex justify-end">
                    <div id="notification-bell" class="notification-bell text-2xl text-slate-400 hover:text-white">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="notification-badge hidden">0</span>
                        <div id="notification-dropdown" class="notification-dropdown text-sm">
                            <!-- Notificações serão inseridas aqui -->
                        </div>
                    </div>
                </div>
            </header>

            <!-- Abas de Módulos -->
            <div class="mb-4 border-b border-slate-700">
                <nav id="module-tabs" class="flex -mb-px overflow-x-auto">
                    <button class="tab-btn" data-module="DASHBOARD">Dashboard</button>
                    <button class="tab-btn" data-module="CONTAS A PAGAR">Contas a Pagar</button>
                    <button class="tab-btn" data-module="DESPESAS ADM MENSAIS">Despesas ADM</button>
                    <button class="tab-btn" data-module="FOLHA DE PAGAMENTO">Folha de Pagamento</button>
                    <button class="tab-btn" data-module="IMPOSTOS">Impostos</button>
                    <button class="tab-btn" data-module="CONTAS AVULSAS">Contas Avulsas</button>
                </nav>
            </div>
            
            <!-- Filtros de Data e Exportação -->
            <div id="controls-section" class="flex flex-wrap justify-center items-center gap-4 mb-8">
                <div class="flex items-center gap-4">
                    <div>
                        <label for="year-filter" class="text-sm font-medium text-slate-400 mr-2">Ano:</label>
                        <select id="year-filter" class="filter-select"><option value="all">Todos</option></select>
                    </div>
                    <div>
                        <label for="month-filter" class="text-sm font-medium text-slate-400 mr-2">Mês:</label>
                        <select id="month-filter" class="filter-select" disabled>
                            <option value="all">Todos</option><option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option><option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option><option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
                        </select>
                    </div>
                </div>
                 <button id="manage-tags-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    <i class="fas fa-tags"></i> Gerir Tags
                </button>
                <button id="export-pdf-btn" class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            </div>

            <!-- Conteúdo Principal -->
            <main id="main-content">
                <!-- Cards de Resumo -->
                <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg">
                        <h2 id="total-value-title" class="text-slate-400 text-lg mb-2">Valor Total</h2>
                        <p id="total-value" class="text-3xl font-bold text-white">R$ 0,00</p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg">
                        <h2 id="pending-count-title" class="text-slate-400 text-lg mb-2">Total Pendente</h2>
                        <p id="pending-count" class="text-3xl font-bold text-red-500">0</p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg">
                        <h2 id="paid-count-title" class="text-slate-400 text-lg mb-2">Total Efetuado</h2>
                        <p id="paid-count" class="text-3xl font-bold text-green-500">0</p>
                    </div>
                </div>

                <!-- Seção de Gráficos (Apenas no Dashboard) -->
                <div id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="chart-container flex flex-col">
                        <h3 class="text-xl font-bold text-white mb-4 flex-shrink-0">Custos por Módulo</h3>
                        <div class="relative flex-grow"><canvas id="modules-chart"></canvas></div>
                    </div>
                    <div class="chart-container flex flex-col">
                        <h3 class="text-xl font-bold text-white mb-4 flex-shrink-0">Status de Pagamentos</h3>
                        <div class="relative flex-grow"><canvas id="status-chart"></canvas></div>
                    </div>
                    <div class="lg:col-span-2 chart-container flex flex-col">
                        <h3 class="text-xl font-bold text-white mb-4 flex-shrink-0">Custos por Tag (Top 10)</h3>
                        <div class="relative flex-grow"><canvas id="tags-chart"></canvas></div>
                    </div>
                </div>

                <!-- Conteúdo do Módulo (Tabela e Filtros) -->
                <div id="module-content" class="hidden">
                     <!-- Filtros Avançados e Pesquisa -->
                    <div class="flex flex-wrap gap-4 items-center mb-6 bg-slate-800 p-4 rounded-lg">
                        <div class="relative flex-grow">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-slate-500"></i></span>
                            <input type="text" id="search-input" placeholder="Pesquisar por descrição..." class="search-input w-full pl-10">
                        </div>
                        <select id="priority-filter" class="filter-select">
                            <option value="all">Todas Prioridades</option>
                            <option value="Alta">Alta</option><option value="Media">Média</option><option value="Baixa">Baixa</option>
                        </select>
                        <select id="payment-method-filter" class="filter-select">
                            <option value="all">Todas Formas</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option><option value="Débito">Débito</option><option value="PIX">PIX</option><option value="Dinheiro">Dinheiro</option>
                        </select>
                        <select id="tag-filter" class="filter-select">
                            <option value="all">Todas as Tags</option>
                        </select>
                        <div id="add-payment-container">
                            <button id="add-payment-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                <i class="fas fa-plus-circle"></i> Adicionar
                            </button>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-2xl shadow-lg border border-slate-700 overflow-hidden">
                        <div class="table-responsive">
                            <table class="w-full text-left">
                                <thead class="bg-slate-700/50">
                                    <tr>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">Descrição</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">Tag</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">Valor</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">Vencimento</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider text-center">Prioridade</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider text-center">Status</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="payment-table-body" class="divide-y divide-slate-700"></tbody>
                            </table>
                        </div>
                        <div id="empty-state" class="text-center p-12 text-slate-400">
                            <i class="fas fa-file-invoice-dollar fa-3x mb-4"></i>
                            <p class="font-semibold">Nenhum pagamento encontrado.</p>
                            <p>Tente ajustar os filtros ou adicione um novo pagamento.</p>
                        </div>
                         <!-- Controles de Paginação -->
                        <div id="pagination-controls" class="flex justify-center items-center gap-4 p-4 bg-slate-800 border-t border-slate-700">
                            <button id="prev-page-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                            <span id="page-info" class="text-slate-400">Página 1 de 1</span>
                            <button id="next-page-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Próximo</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Pagamento -->
    <div id="payment-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-2xl mx-auto rounded-2xl shadow-2xl border border-slate-700">
                <form id="payment-form" class="p-8 space-y-6">
                    <h2 id="modal-title" class="text-2xl font-bold mb-6 text-white">Adicionar Novo Pagamento</h2>
                    <input type="hidden" id="payment-id" name="payment-id">
                    
                    <div>
                        <label for="description" class="block text-sm font-medium text-slate-300 mb-2">Descrição</label>
                        <input type="text" id="description" name="description" placeholder="Ex: Conta de Luz" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="date" class="block text-sm font-medium text-slate-300 mb-2">Data Lançamento</label>
                            <input type="date" id="date" name="date" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        </div>
                        <div>
                            <label for="dueDate" class="block text-sm font-medium text-slate-300 mb-2">Data Vencimento</label>
                            <input type="date" id="dueDate" name="dueDate" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="value" class="block text-sm font-medium text-slate-300 mb-2">Valor (R$)</label>
                            <input type="text" id="value" name="value" placeholder="18.662,58" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        </div>
                        <div>
                            <label for="payment-method" class="block text-sm font-medium text-slate-300 mb-2">Forma de Pagamento</label>
                            <select id="payment-method" name="payment-method" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <option value="Cartão de Crédito">Cartão de Crédito</option> <option value="Débito">Débito</option> <option value="PIX">PIX</option> <option value="Dinheiro">Dinheiro</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="module" class="block text-sm font-medium text-slate-300 mb-2">Módulo</label>
                            <select id="module" name="module" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <option value="DESPESAS ADM MENSAIS">Despesas ADM Mensais</option> <option value="FOLHA DE PAGAMENTO">Folha de Pagamento</option> <option value="IMPOSTOS">Impostos</option> <option value="CONTAS AVULSAS">Contas Avulsas</option>
                            </select>
                        </div>
                        <div>
                            <label for="priority" class="block text-sm font-medium text-slate-300 mb-2">Prioridade</label>
                            <select id="priority" name="priority" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <option value="Baixa">Baixa</option> <option value="Media">Média</option> <option value="Alta">Alta</option>
                            </select>
                        </div>
                    </div>

                     <!-- Campo de Tags -->
                    <div>
                        <label for="tags-select" class="block text-sm font-medium text-slate-300 mb-2">Tag</label>
                        <select id="tags-select" name="tag" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="">Nenhuma</option>
                            <!-- Opções de tags serão inseridas aqui -->
                        </select>
                    </div>

                    <!-- Seção de Recorrência -->
                    <div class="bg-slate-700/50 p-4 rounded-lg space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="is-recurring" name="is-recurring" class="h-4 w-4 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500">
                            <label for="is-recurring" class="ml-3 block text-sm font-medium text-slate-200">É um pagamento recorrente?</label>
                        </div>
                        <div id="recurring-options" class="hidden space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="recurrence-frequency" class="block text-sm font-medium text-slate-300 mb-2">Frequência</label>
                                    <select id="recurrence-frequency" name="recurrence-frequency" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                                        <option value="monthly">Mensal</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="recurrence-count" class="block text-sm font-medium text-slate-300 mb-2">Repetir por (meses)</label>
                                    <input type="number" id="recurrence-count" name="recurrence-count" value="1" min="1" max="120" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                                </div>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="is-permanent" name="is-permanent" class="h-4 w-4 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500">
                                <label for="is-permanent" class="ml-3 block text-sm font-medium text-slate-200">Permanente (10 anos)</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="attachment" class="block text-sm font-medium text-slate-300 mb-2">Anexar Comprovativo</label>
                            <input type="file" id="attachment" name="attachment" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-slate-300 mb-2">Status</label>
                            <select id="status" name="status" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <option value="Pendente">Pendente</option> <option value="Pago">Pago</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition">Cancelar</button>
                        <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Gestão de Tags -->
    <div id="manage-tags-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-lg mx-auto rounded-2xl shadow-2xl border border-slate-700">
                <div class="p-8">
                    <h2 class="text-2xl font-bold mb-6 text-white">Gerir Tags</h2>
                    <form id="add-tag-form" class="flex gap-2 mb-4">
                        <input type="text" id="new-tag-name" placeholder="Nome da nova tag" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Adicionar</button>
                    </form>
                    <div id="tags-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Lista de tags será inserida aqui -->
                    </div>
                    <div class="flex justify-end mt-8">
                        <button type="button" id="close-tags-modal-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="confirm-delete-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-md mx-auto rounded-2xl shadow-2xl border border-slate-700 p-8 text-center">
                <h3 class="text-xl font-bold text-white mb-4">Confirmar Exclusão</h3>
                <p id="delete-confirm-text" class="text-slate-300 mb-8"></p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-delete-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition">Cancelar</button>
                    <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DA UI ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');

            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const addPaymentBtn = document.getElementById('add-payment-btn');
            const paymentModal = document.getElementById('payment-modal');
            const paymentForm = document.getElementById('payment-form');
            const cancelBtn = document.getElementById('cancel-btn');
            const tableBody = document.getElementById('payment-table-body');
            const modalTitle = document.getElementById('modal-title');
            const paymentIdInput = document.getElementById('payment-id');
            const emptyState = document.getElementById('empty-state');
            const moduleTabsContainer = document.getElementById('module-tabs');
            const chartsSection = document.getElementById('charts-section');
            const moduleContent = document.getElementById('module-content');
            const yearFilter = document.getElementById('year-filter');
            const monthFilter = document.getElementById('month-filter');
            const searchInput = document.getElementById('search-input');
            const priorityFilter = document.getElementById('priority-filter');
            const paymentMethodFilter = document.getElementById('payment-method-filter');
            const tagFilter = document.getElementById('tag-filter');
            const notificationBell = document.getElementById('notification-bell');
            const notificationBadge = document.getElementById('notification-badge');
            const notificationDropdown = document.getElementById('notification-dropdown');
            const isRecurringCheckbox = document.getElementById('is-recurring');
            const recurringOptions = document.getElementById('recurring-options');
            const isPermanentCheckbox = document.getElementById('is-permanent');
            const recurrenceCountInput = document.getElementById('recurrence-count');
            const confirmDeleteModal = document.getElementById('confirm-delete-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const paginationControls = document.getElementById('pagination-controls');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const pageInfo = document.getElementById('page-info');
            const tagsSelect = document.getElementById('tags-select');
            const manageTagsBtn = document.getElementById('manage-tags-btn');
            const manageTagsModal = document.getElementById('manage-tags-modal');
            const closeTagsModalBtn = document.getElementById('close-tags-modal-btn');
            const addTagForm = document.getElementById('add-tag-form');
            const newTagNameInput = document.getElementById('new-tag-name');
            const tagsListContainer = document.getElementById('tags-list');
            const deleteConfirmText = document.getElementById('delete-confirm-text');
            
            // Resumo
            const totalValueEl = document.getElementById('total-value');
            const pendingCountEl = document.getElementById('pending-count');
            const paidCountEl = document.getElementById('paid-count');
            const totalValueTitle = document.getElementById('total-value-title');
            const pendingCountTitle = document.getElementById('pending-count-title');
            const paidCountTitle = document.getElementById('paid-count-title');

            // --- ESTADO DA APLICAÇÃO ---
            let currentModule = 'DASHBOARD';
            let allPayments = []; 
            let allTags = [];
            const moduleNames = ["DESPESAS ADM MENSAIS", "FOLHA DE PAGAMENTO", "IMPOSTOS", "CONTAS AVULSAS"];
            let modulesChartInstance = null;
            let statusChartInstance = null;
            let tagsChartInstance = null;
            let selectedYear = 'all', selectedMonth = 'all', searchTerm = '', selectedPriority = 'all', selectedPaymentMethod = 'all', selectedTag = 'all';
            let itemToDelete = { id: null, type: null };

            let currentPage = 1;
            const ITEMS_PER_PAGE = 50;
            let totalItems = 0;

            // --- CONFIGURAÇÃO DO SUPABASE ---
            const SUPABASE_URL = 'https://cykvtziwulnqgyyaeugj.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5a3Z0eml3dWxucWd5eWFldWdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzODkyMTcsImV4cCI6MjA2Njk2NTIxN30.fbSC1VOp0OT7TKnGAgwbaiqPEAMUty4bfgRN6esCLZo';

            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const showLoader = () => loadingOverlay.style.display = 'flex';
            const hideLoader = () => loadingOverlay.style.display = 'none';

            // --- LÓGICA DE LOGIN ---
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (username === 'pontazobank' && password === 'pontazobank@2025') {
                    loginScreen.style.display = 'none';
                    appContainer.classList.remove('hidden');
                    initializeMainApp();
                } else {
                    loginError.textContent = 'Utilizador ou senha inválidos.';
                }
            });

            async function initializeMainApp() {
                // --- FUNÇÕES AUXILIARES ---
                const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                const formatDate = (dateString) => {
                    if (!dateString) return 'N/A';
                    const [year, month, day] = dateString.split('-');
                    return `${day}/${month}/${year}`;
                };
                const parseCurrency = (valueString) => {
                    if (typeof valueString !== 'string') return NaN;
                    return parseFloat(valueString.replace(/\./g, '').replace(',', '.'));
                }
                const stringToColor = (str) => {
                    let hash = 0;
                    if (!str) return '#64748b'; // Cor padrão para tags nulas/indefinidas
                    for (let i = 0; i < str.length; i++) {
                        hash = str.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    // Garante cores mais claras e com mais saturação
                    const h = hash % 360;
                    return `hsla(${h}, 70%, 70%, 1)`;
                }
                
                // --- BUSCAR DADOS DO SUPABASE ---
                async function fetchPaginatedPayments() {
                    showLoader();
                    let query = _supabase.from('payments').select('*', { count: 'exact' });

                    // Aplicar filtros
                    if (currentModule === 'CONTAS A PAGAR') {
                        query = query.eq('status', 'Pendente');
                    } else if (currentModule !== 'DASHBOARD') {
                        query = query.eq('module', currentModule);
                    }

                    if (searchTerm) query = query.ilike('description', `%${searchTerm}%`);
                    if (selectedPriority !== 'all') query = query.eq('priority', selectedPriority);
                    if (selectedPaymentMethod !== 'all') query = query.eq('paymentMethod', selectedPaymentMethod);
                    if (selectedTag !== 'all') query = query.eq('tag', selectedTag);
                    
                    if (selectedYear !== 'all') {
                        const startDate = `${selectedYear}-01-01`;
                        const endDate = `${selectedYear}-12-31`;
                        if (selectedMonth !== 'all') {
                            const monthStartDate = new Date(selectedYear, selectedMonth, 1).toISOString().slice(0,10);
                            const monthEndDate = new Date(selectedYear, parseInt(selectedMonth) + 1, 0).toISOString().slice(0,10);
                            query = query.gte('date', monthStartDate).lte('date', monthEndDate);
                        } else {
                            query = query.gte('date', startDate).lte('date', endDate);
                        }
                    }

                    // Paginação
                    const from = (currentPage - 1) * ITEMS_PER_PAGE;
                    const to = from + ITEMS_PER_PAGE - 1;
                    query = query.range(from, to).order('dueDate', { ascending: true });

                    const { data, error, count } = await query;
                    hideLoader();

                    if (error) {
                        console.error('Erro ao buscar pagamentos:', error);
                        return;
                    }

                    allPayments = data;
                    totalItems = count;
                    updateUI();
                }

                async function fetchAllFilteredDataForDashboard() {
                    showLoader();
                    let query = _supabase.from('payments').select('*');
                    if (selectedYear !== 'all') {
                        const startDate = `${selectedYear}-01-01`;
                        const endDate = `${selectedYear}-12-31`;
                        if (selectedMonth !== 'all') {
                            const monthStartDate = new Date(selectedYear, selectedMonth, 1).toISOString().slice(0,10);
                            const monthEndDate = new Date(selectedYear, parseInt(selectedMonth) + 1, 0).toISOString().slice(0,10);
                            query = query.gte('date', monthStartDate).lte('date', monthEndDate);
                        } else {
                            query = query.gte('date', startDate).lte('date', endDate);
                        }
                    }
                    const { data, error } = await query;
                    hideLoader();
                    if (error) {
                        console.error('Erro ao buscar dados para o dashboard:', error);
                        return [];
                    }
                    return data;
                }

                // --- LÓGICA DO MODAL ---
                const openModal = () => paymentModal.style.display = 'flex';
                const closeModal = () => {
                    paymentModal.style.display = 'none';
                    paymentForm.reset();
                    recurringOptions.classList.add('hidden');
                    recurrenceCountInput.disabled = false;
                    paymentIdInput.value = '';
                    modalTitle.textContent = 'Adicionar Novo Pagamento';
                };
                isRecurringCheckbox.addEventListener('change', () => recurringOptions.classList.toggle('hidden', !isRecurringCheckbox.checked));
                isPermanentCheckbox.addEventListener('change', () => recurrenceCountInput.disabled = isPermanentCheckbox.checked);
                
                // --- LÓGICA DE FILTROS ---
                const populateYearFilter = async () => {
                    showLoader();
                    const { data, error } = await _supabase.from('payments').select('date');
                    hideLoader();
                    
                    if (error) {
                        console.error('Erro ao buscar datas para o filtro de ano:', error);
                        const currentYear = new Date().getFullYear().toString();
                        yearFilter.innerHTML = '<option value="all">Todos</option>';
                        yearFilter.add(new Option(currentYear, currentYear));
                        return;
                    }
                    
                    const years = [...new Set(data.map(p => p.date.substring(0, 4)))];
                    const currentYear = new Date().getFullYear().toString();
                    if (!years.includes(currentYear)) {
                        years.push(currentYear);
                    }
                    years.sort().reverse();
                    yearFilter.innerHTML = '<option value="all">Todos</option>';
                    years.forEach(year => yearFilter.add(new Option(year, year)));
                };

                const applyFilters = () => {
                    currentPage = 1; // Reset page on new filter
                    selectedYear = yearFilter.value;
                    selectedMonth = monthFilter.value;
                    searchTerm = searchInput.value;
                    selectedPriority = priorityFilter.value;
                    selectedPaymentMethod = paymentMethodFilter.value;
                    selectedTag = tagFilter.value;
                    monthFilter.disabled = selectedYear === 'all';
                    
                    if(currentModule === 'DASHBOARD') {
                        updateUI(); // Dashboard fetches all data
                    } else {
                        fetchPaginatedPayments(); // Modules fetch paginated data
                    }
                };

                // --- LÓGICA DE NOTIFICAÇÕES ---
                const updateNotifications = async () => {
                    const today = new Date().toISOString().slice(0, 10);
                    const sevenDaysFromNow = new Date();
                    sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
                    const sevenDaysISO = sevenDaysFromNow.toISOString().slice(0, 10);

                    const { data: overdue, error: overdueError } = await _supabase.from('payments').select('description, dueDate').eq('status', 'Pendente').lt('dueDate', today);
                    const { data: upcoming, error: upcomingError } = await _supabase.from('payments').select('description, dueDate').eq('status', 'Pendente').gte('dueDate', today).lte('dueDate', sevenDaysISO);
                    
                    if(overdueError || upcomingError) { console.error('Erro ao buscar notificações'); return; }

                    const totalNotifications = overdue.length + upcoming.length;
                    notificationDropdown.innerHTML = '';

                    if (totalNotifications > 0) {
                        notificationBadge.textContent = totalNotifications;
                        notificationBadge.classList.remove('hidden');
                        if (overdue.length > 0) {
                            notificationDropdown.innerHTML += `<div class="p-2 font-bold text-red-400 border-b border-slate-600">Vencidas (${overdue.length})</div>`;
                            overdue.forEach(p => notificationDropdown.innerHTML += `<div class="p-2 border-b border-slate-700"><strong>${p.description}</strong><br><span class="text-xs text-slate-400">Venceu em: ${formatDate(p.dueDate)}</span></div>`);
                        }
                        if (upcoming.length > 0) {
                            notificationDropdown.innerHTML += `<div class="p-2 font-bold text-amber-400 border-b border-slate-600">A Vencer (${upcoming.length})</div>`;
                            upcoming.forEach(p => notificationDropdown.innerHTML += `<div class="p-2 border-b border-slate-700"><strong>${p.description}</strong><br><span class="text-xs text-slate-400">Vence em: ${formatDate(p.dueDate)}</span></div>`);
                        }
                    } else {
                        notificationBadge.classList.add('hidden');
                        notificationDropdown.innerHTML = `<div class="p-4 text-center text-slate-400">Nenhuma notificação.</div>`;
                    }
                };
                notificationBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationDropdown.style.display = notificationDropdown.style.display === 'block' ? 'none' : 'block';
                });
                window.addEventListener('click', () => notificationDropdown.style.display = 'none');

                // --- LÓGICA DE RENDERIZAÇÃO ---
                const updateUI = async () => {
                    updateActiveTab();
                    const addPaymentContainer = document.getElementById('add-payment-container');
                    
                    if (currentModule === 'DASHBOARD') {
                        paginationControls.style.display = 'none';
                        chartsSection.style.display = 'grid';
                        moduleContent.style.display = 'none';
                        const dashboardData = await fetchAllFilteredDataForDashboard();
                        updateDashboard(dashboardData);
                    } else {
                        paginationControls.style.display = 'flex';
                        chartsSection.style.display = 'none';
                        moduleContent.style.display = 'block';
                        addPaymentContainer.style.display = currentModule === 'CONTAS A PAGAR' ? 'none' : 'block';
                        renderTable(allPayments);
                        updateModuleSummary(allPayments);
                        updatePaginationControls();
                    }
                    updateNotifications();
                };

                // --- PAGINAÇÃO ---
                const updatePaginationControls = () => {
                    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                    pageInfo.textContent = `Página ${currentPage} de ${totalPages || 1}`;
                    prevPageBtn.disabled = currentPage === 1;
                    nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
                };

                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        fetchPaginatedPayments();
                    }
                });

                nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                    if (currentPage < totalPages) {
                        currentPage++;
                        fetchPaginatedPayments();
                    }
                });

                // --- DASHBOARD ---
                const updateDashboard = (payments) => {
                    const totalValue = payments.reduce((sum, p) => sum + p.value, 0);
                    const totalPendingValue = payments.filter(p => p.status === 'Pendente').reduce((sum, p) => sum + p.value, 0);
                    const totalPaidValue = payments.filter(p => p.status === 'Pago').reduce((sum, p) => sum + p.value, 0);
                    totalValueEl.textContent = formatCurrency(totalValue);
                    pendingCountEl.textContent = formatCurrency(totalPendingValue);
                    paidCountEl.textContent = formatCurrency(totalPaidValue);
                    renderModulesChart(payments);
                    renderStatusChart(payments);
                    renderTagsChart(payments);
                };
                
                const renderModulesChart = (payments) => {
                    const ctx = document.getElementById('modules-chart').getContext('2d');
                    const data = {
                        labels: moduleNames,
                        datasets: [{
                            label: 'Custo Total',
                            data: moduleNames.map(module => payments.filter(p => p.module === module).reduce((sum, p) => sum + p.value, 0)),
                            backgroundColor: ['#06b6d4', '#0891b2', '#0e7490', '#155e75'],
                            borderColor: '#1e293b', borderWidth: 2, borderRadius: 5,
                        }]
                    };
                    if (modulesChartInstance) modulesChartInstance.destroy();
                    modulesChartInstance = new Chart(ctx, {
                        type: 'bar', data: data,
                        options: {
                            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => formatCurrency(c.parsed.x) } } },
                            scales: { y: { ticks: { color: '#94a3b8' }, grid: { display: false } }, x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' }, title: { display: true, text: 'Valor (R$)', color: '#94a3b8' } } }
                        }
                    });
                };
                
                const renderStatusChart = (payments) => {
                    const ctx = document.getElementById('status-chart').getContext('2d');
                    const paidValue = payments.filter(p => p.status === 'Pago').reduce((sum, p) => sum + p.value, 0);
                    const pendingValue = payments.filter(p => p.status === 'Pendente').reduce((sum, p) => sum + p.value, 0);
                    const data = {
                        labels: ['Pago', 'Pendente'],
                        datasets: [{ data: [paidValue, pendingValue], backgroundColor: ['#10B981', '#EF4444'], borderColor: '#1e293b', borderWidth: 4 }]
                    };
                    if (statusChartInstance) statusChartInstance.destroy();
                    statusChartInstance = new Chart(ctx, {
                        type: 'doughnut', data: data,
                        options: {
                            responsive: true, maintainAspectRatio: false, cutout: '70%',
                            plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.parsed)}` } } }
                        }
                    });
                };

                const renderTagsChart = (payments) => {
                    const ctx = document.getElementById('tags-chart').getContext('2d');
                    const tagsData = {};
                    payments.forEach(p => {
                        if (p.tag) {
                            if (!tagsData[p.tag]) tagsData[p.tag] = 0;
                            tagsData[p.tag] += p.value;
                        }
                    });
                    
                    const sortedTags = Object.entries(tagsData).sort(([,a],[,b]) => b-a).slice(0, 10);
                    const labels = sortedTags.map(item => item[0]);
                    const dataValues = sortedTags.map(item => item[1]);

                    const data = {
                        labels: labels,
                        datasets: [{
                            label: 'Custo por Tag',
                            data: dataValues,
                            backgroundColor: labels.map(label => stringToColor(label)),
                            borderColor: '#1e293b', borderWidth: 4
                        }]
                    };
                    if (tagsChartInstance) tagsChartInstance.destroy();
                    tagsChartInstance = new Chart(ctx, {
                        type: 'doughnut', data: data,
                        options: {
                            responsive: true, maintainAspectRatio: false, cutout: '70%',
                            plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${formatCurrency(c.parsed)}` } } }
                        }
                    });
                };

                // --- MÓDULOS INDIVIDUAIS ---
                const updateModuleSummary = (payments) => {
                    const totalValue = payments.reduce((sum, p) => sum + p.value, 0);
                    const pendingCount = payments.filter(p => p.status === 'Pendente').length;
                    const paidCount = payments.length - pendingCount;
                    totalValueEl.textContent = formatCurrency(totalValue);
                    pendingCountEl.textContent = pendingCount;
                    paidCountEl.textContent = paidCount;
                };

                const renderTable = (payments) => {
                    tableBody.innerHTML = '';
                    emptyState.style.display = payments.length === 0 ? 'block' : 'none';
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    payments.forEach(p => {
                        const isOverdue = p.status === 'Pendente' && new Date(p.dueDate + 'T00:00:00') < today;
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-slate-700/50 transition-colors';
                        const tagHtml = p.tag ? `<span class="tag-badge" style="background-color: ${stringToColor(p.tag)}20; color: ${stringToColor(p.tag)};">${p.tag}</span>` : '';
                        row.innerHTML = `
                            <td class="p-4 font-medium text-white">${p.description} ${p.attachment ? `<a href="${p.attachment}" target="_blank" class="text-cyan-400 hover:text-cyan-300" title="Ver Anexo"><i class="fas fa-paperclip ml-2"></i></a>` : ''}</td>
                            <td class="p-4">${tagHtml}</td>
                            <td class="p-4 font-medium text-white whitespace-nowrap">${formatCurrency(p.value)}</td>
                            <td class="p-4 whitespace-nowrap ${isOverdue ? 'text-overdue' : ''}">${formatDate(p.dueDate)}</td>
                            <td class="p-4 text-center"><span class="priority-badge priority-${p.priority.toLowerCase()}">${p.priority}</span></td>
                            <td class="p-4 text-center"><span class="status-badge ${p.status === 'Pago' ? 'status-pago' : 'status-pendente'}">${p.status}</span></td>
                            <td class="p-4 text-center whitespace-nowrap">
                                <button data-id="${p.id}" class="edit-btn text-cyan-400 hover:text-cyan-300 mx-2" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                                <button data-id="${p.id}" class="delete-btn text-red-500 hover:text-red-400 mx-2" title="Excluir"><i class="fas fa-trash-alt"></i></button>
                                ${p.status === 'Pendente' ? `<button data-id="${p.id}" class="toggle-status-btn text-green-500 hover:text-green-400 mx-2" title="Marcar como Pago"><i class="fas fa-check-circle"></i></button>` : ''}
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    addTableEventListeners();
                };

                const updateActiveTab = () => {
                    document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.toggle('active', tab.dataset.module === currentModule));
                };

                // --- LÓGICA DE EXPORTAÇÃO PDF ---
                const exportToPDF = async () => {
                    showLoader();
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const todayDate = new Date().toISOString().slice(0, 10);
                    const period = selectedYear === 'all' ? 'Geral' : `${selectedMonth !== 'all' ? monthFilter.options[monthFilter.selectedIndex].text + ' de ' : ''}${selectedYear}`;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.text('PONTAZO BANK', 14, 22);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(12);
                    
                    if (currentModule === 'DASHBOARD') {
                        doc.text(`Relatório do Dashboard - Período: ${period}`, 14, 30);
                        const dashboardData = await fetchAllFilteredDataForDashboard();
                        const totalValue = dashboardData.reduce((sum, p) => sum + p.value, 0);
                        const totalPendingValue = dashboardData.filter(p => p.status === 'Pendente').reduce((sum, p) => sum + p.value, 0);
                        const totalPaidValue = dashboardData.filter(p => p.status === 'Pago').reduce((sum, p) => sum + p.value, 0);
                        
                        const modulesChartImg = document.getElementById('modules-chart').toDataURL('image/png');
                        const statusChartImg = document.getElementById('status-chart').toDataURL('image/png');
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Resumo do Período', 14, 45);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(11);
                        doc.text(`Valor Total: ${formatCurrency(totalValue)}`, 14, 52);
                        doc.text(`Total Pendente: ${formatCurrency(totalPendingValue)}`, 14, 59);
                        doc.text(`Total Efetuado: ${formatCurrency(totalPaidValue)}`, 14, 66);
                        doc.addImage(modulesChartImg, 'PNG', 14, 80, 180, 90);
                        doc.addPage();
                        doc.addImage(statusChartImg, 'PNG', 14, 20, 180, 90);
                        doc.save(`Relatorio_Dashboard_PONTAZO_BANK_${todayDate}.pdf`);
                    } else {
                        const { data } = await _supabase.from('payments').select('*').eq('module', currentModule); // Fetch all for PDF
                        const total = data.reduce((sum, p) => sum + p.value, 0);
                        doc.text(`Relatório de ${currentModule}`, 14, 30);
                        doc.text(`Período: ${period}`, 14, 37);
                        const head = [['Descrição', 'Valor', 'Vencimento', 'Prioridade', 'Status']];
                        const body = data.map(p => [p.description, formatCurrency(p.value), formatDate(p.dueDate), p.priority, p.status]);
                        doc.autoTable({
                            head: head, body: body, startY: 45, theme: 'grid',
                            foot: [['Total', formatCurrency(total), '', '', '']],
                            footStyles: { fillColor: [22, 163, 74], fontStyle: 'bold' },
                            headStyles: { fillColor: [30, 41, 59] }
                        });
                        doc.save(`Relatorio_${currentModule.replace(/\s/g, '_')}_PONTAZO_BANK_${todayDate}.pdf`);
                    }
                    hideLoader();
                };

                // --- LÓGICA DE TAGS ---
                const fetchTags = async () => {
                    const { data, error } = await _supabase.from('tags').select('id, name').order('name');
                    if (error) { console.error('Erro ao buscar tags:', error); return; }
                    allTags = data;
                    populateTagFilter();
                    renderTagsInManageModal();
                    populateTagsInPaymentModal();
                };

                const populateTagFilter = () => {
                    tagFilter.innerHTML = '<option value="all">Todas as Tags</option>';
                    allTags.forEach(tag => tagFilter.add(new Option(tag.name, tag.name)));
                };
                
                const populateTagsInPaymentModal = () => {
                    tagsSelect.innerHTML = '<option value="">Nenhuma</option>';
                    allTags.forEach(tag => {
                        tagsSelect.add(new Option(tag.name, tag.name));
                    });
                };

                const renderTagsInManageModal = () => {
                    tagsListContainer.innerHTML = '';
                    allTags.forEach(tag => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-2 bg-slate-700 rounded';
                        div.textContent = tag.name;
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.className = 'ml-4 text-red-400 hover:text-red-200 font-bold text-xl';
                        deleteBtn.onclick = () => {
                            itemToDelete = { id: tag.id, type: 'tag' };
                            deleteConfirmText.textContent = `Tem a certeza que deseja excluir a tag "${tag.name}"?`;
                            confirmDeleteModal.style.display = 'flex';
                        };
                        div.appendChild(deleteBtn);
                        tagsListContainer.appendChild(div);
                    });
                };

                // --- EVENT LISTENERS ---
                paymentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoader();
                    const formData = new FormData(paymentForm);
                    const id = formData.get('payment-id');
                    const isRecurring = formData.get('is-recurring') === 'on';
                    const isPermanent = formData.get('is-permanent') === 'on';
                    const attachmentFile = document.getElementById('attachment').files[0];
                    let attachmentUrl = id ? allPayments.find(p => p.id == id).attachment : null;

                    if (attachmentFile) {
                        const filePath = `public/${Date.now()}-${attachmentFile.name}`;
                        const { error: uploadError } = await _supabase.storage.from('comprovativos').upload(filePath, attachmentFile);
                        if (uploadError) { console.error('Erro no upload do anexo:', uploadError); alert('Falha ao enviar o anexo.'); hideLoader(); return; }
                        const { data: urlData } = _supabase.storage.from('comprovativos').getPublicUrl(filePath);
                        attachmentUrl = urlData.publicUrl;
                    }

                    const rawValue = formData.get('value').toString();
                    const sanitizedValue = parseCurrency(rawValue);

                    const basePaymentData = {
                        description: formData.get('description'), value: sanitizedValue, paymentMethod: formData.get('payment-method'),
                        module: formData.get('module'), priority: formData.get('priority'), status: formData.get('status'), attachment: attachmentUrl,
                        tag: formData.get('tag') || null
                    };

                    if (id && !isRecurring) {
                        const { error } = await _supabase.from('payments').update({ ...basePaymentData, date: formData.get('date'), dueDate: formData.get('dueDate') }).eq('id', id);
                        if (error) console.error("Erro ao atualizar:", error);
                    } else if (isRecurring) {
                        const recurrenceCount = isPermanent ? 120 : parseInt(formData.get('recurrence-count'), 10);
                        let currentLaunchDate = new Date(formData.get('date') + 'T00:00:00');
                        let currentDueDate = new Date(formData.get('dueDate') + 'T00:00:00');
                        const paymentsToInsert = [];
                        for (let i = 0; i < recurrenceCount; i++) {
                            paymentsToInsert.push({
                                ...basePaymentData, description: `${basePaymentData.description} (${i + 1}/${recurrenceCount})`,
                                date: currentLaunchDate.toISOString().slice(0, 10), dueDate: currentDueDate.toISOString().slice(0, 10),
                            });
                            currentLaunchDate.setMonth(currentLaunchDate.getMonth() + 1);
                            currentDueDate.setMonth(currentDueDate.getMonth() + 1);
                        }
                        const { error } = await _supabase.from('payments').insert(paymentsToInsert);
                        if (error) console.error("Erro ao inserir recorrentes:", error);
                    } else {
                         const { error } = await _supabase.from('payments').insert([{ ...basePaymentData, date: formData.get('date'), dueDate: formData.get('dueDate') }]);
                         if (error) console.error("Erro ao inserir:", error);
                    }
                    
                    closeModal();
                    fetchPaginatedPayments();
                });
                
                moduleTabsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-btn')) {
                        currentModule = e.target.dataset.module;
                        applyFilters();
                    }
                });

                const addTableEventListeners = () => {
                    document.querySelectorAll('.edit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            const payment = allPayments.find(p => p.id === id);
                            if (payment) {
                                modalTitle.textContent = 'Editar Pagamento';
                                paymentIdInput.value = payment.id;
                                document.getElementById('date').value = payment.date;
                                document.getElementById('dueDate').value = payment.dueDate;
                                document.getElementById('description').value = payment.description;
                                document.getElementById('value').value = parseFloat(payment.value).toFixed(2).replace('.', ',');
                                document.getElementById('payment-method').value = payment.paymentMethod;
                                document.getElementById('module').value = payment.module;
                                document.getElementById('priority').value = payment.priority;
                                document.getElementById('status').value = payment.status;
                                document.getElementById('tags-select').value = payment.tag || '';
                                document.getElementById('is-recurring').checked = false;
                                recurringOptions.classList.add('hidden');
                                openModal();
                            }
                        });
                    });

                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            itemToDelete = { id: parseInt(e.currentTarget.dataset.id), type: 'payment' };
                            deleteConfirmText.textContent = 'Tem a certeza que deseja excluir este pagamento? Esta ação não pode ser desfeita.';
                            confirmDeleteModal.style.display = 'flex';
                        });
                    });

                    document.querySelectorAll('.toggle-status-btn').forEach(async (btn) => {
                        btn.addEventListener('click', async (e) => {
                            const id = parseInt(e.currentTarget.dataset.id);
                            showLoader();
                            const { error } = await _supabase.from('payments').update({ status: 'Pago' }).eq('id', id);
                            if (error) console.error("Erro ao marcar como pago:", error);
                            fetchPaginatedPayments();
                        });
                    });
                };

                addPaymentBtn.addEventListener('click', () => {
                    modalTitle.textContent = 'Adicionar Novo Pagamento';
                    const formModuleSelect = document.getElementById('module');
                    if (currentModule !== 'DASHBOARD') formModuleSelect.value = currentModule;
                    else formModuleSelect.value = moduleNames[0];
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('date').value = today;
                    document.getElementById('dueDate').value = today;
                    openModal();
                });
                
                cancelBtn.addEventListener('click', closeModal);
                paymentModal.addEventListener('click', (e) => { if (e.target === paymentModal) closeModal(); });
                
                // Listeners do Modal de Exclusão
                cancelDeleteBtn.addEventListener('click', () => {
                    confirmDeleteModal.style.display = 'none';
                    itemToDelete = { id: null, type: null };
                });

                confirmDeleteBtn.addEventListener('click', async () => {
                    if (itemToDelete.id !== null) {
                        showLoader();
                        if (itemToDelete.type === 'payment') {
                            const { error } = await _supabase.from('payments').delete().eq('id', itemToDelete.id);
                            if (error) console.error("Erro ao excluir pagamento:", error);
                            fetchPaginatedPayments();
                        } else if (itemToDelete.type === 'tag') {
                            const { error } = await _supabase.from('tags').delete().eq('id', itemToDelete.id);
                            if (error) console.error("Erro ao excluir tag:", error);
                            fetchTags();
                        }
                        
                        confirmDeleteModal.style.display = 'none';
                        itemToDelete = { id: null, type: null };
                    }
                });

                // Listeners de Gestão de Tags
                manageTagsBtn.addEventListener('click', () => manageTagsModal.style.display = 'flex');
                closeTagsModalBtn.addEventListener('click', () => manageTagsModal.style.display = 'none');
                addTagForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newTagName = newTagNameInput.value.trim();
                    if (newTagName && !allTags.some(t => t.name.toLowerCase() === newTagName.toLowerCase())) {
                        showLoader();
                        const { error } = await _supabase.from('tags').insert([{ name: newTagName }]);
                        hideLoader();
                        if (error) console.error('Erro ao adicionar tag:', error);
                        else {
                            newTagNameInput.value = '';
                            fetchTags();
                        }
                    }
                });

                [yearFilter, monthFilter, searchInput, priorityFilter, paymentMethodFilter, tagFilter].forEach(el => {
                    el.addEventListener('change', applyFilters);
                    if (el.tagName === 'INPUT') el.addEventListener('keyup', applyFilters);
                });
                exportPdfBtn.addEventListener('click', exportToPDF);

                // --- INICIALIZAÇÃO ---
                populateYearFilter();
                fetchTags();
                applyFilters();
            }
        });
    </script>
</body>
</html>
