<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pagamentos - PONTAZO BANK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Biblioteca de Gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>
    <!-- Biblioteca do Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 40; animation: fadeIn 0.3s ease-out; }
        .modal-content { transform: translateY(-50px); animation: slideIn 0.3s ease-out forwards; max-height: 90vh; overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .status-badge, .priority-badge, .tag-badge { padding: 4px 12px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-pago { background-color: rgba(16, 185, 129, 0.1); color: #10B981; }
        .status-pendente { background-color: rgba(239, 68, 68, 0.1); color: #EF4444; }
        .priority-alta { background-color: rgba(239, 68, 68, 0.2); color: #f87171; }
        .priority-media { background-color: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .priority-baixa { background-color: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .tag-badge { margin: 2px; display: inline-block; }
        .text-overdue { color: #ef4444; font-weight: 700; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab-btn { padding: 0.75rem 1.5rem; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-weight: 600; color: #94a3b8; }
        .tab-btn.active { color: #22d3ee; border-bottom-color: #22d3ee; }
        .tab-btn:hover { color: #e2e8f0; }
        .chart-container { background-color: #1e293b; padding: 1.5rem; border-radius: 1rem; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); height: 400px; }
        .filter-select, .search-input { background-color: #1e293b; border: 1px solid #334155; color: #e2e8f0; border-radius: 0.5rem; padding: 0.5rem 1rem; }
        .notification-bell { position: relative; cursor: pointer; }
        .notification-badge { position: absolute; top: -5px; right: -8px; background-color: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; }
        .notification-dropdown { position: absolute; top: 100%; right: 0; background-color: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; width: 300px; max-height: 400px; overflow-y: auto; z-index: 50; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .loading-overlay { display: none; position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.8); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .loader { border: 5px solid #334155; border-top: 5px solid #22d3ee; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-autorizado { background-color: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .status-nao-autorizado { background-color: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .status-autorizacao-pendente { background-color: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay"><div class="loader"></div></div>

    <!-- Tela de Login -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="w-full max-w-md bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white">PONTAZO <span class="text-cyan-400">BANK</span></h1>
                <p class="text-slate-400 mt-2">Acesso ao Sistema Financeiro</p>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-bold text-slate-300 mb-2">Utilizador</label>
                    <input type="text" id="username" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-bold text-slate-300 mb-2">Senha</label>
                    <input type="password" id="password" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                </div>
                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Entrar</button>
                <p id="login-error" class="text-red-500 text-center mt-4 h-4"></p>
            </form>
        </div>
    </div>

    <!-- Conteúdo Principal da Aplicação (inicialmente oculto) -->
    <div id="app-container" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <!-- Cabeçalho -->
            <header class="flex justify-between items-center mb-8">
                 <!-- Seletor de Empresa -->
                <div class="w-1/3 relative">
                    <select id="company-selector" class="filter-select w-full max-w-xs text-lg">
                        <!-- Opções de empresa serão carregadas aqui -->
                    </select>
                </div>
                <div class="w-1/3 text-center">
                    <h1 class="text-4xl md:text-5xl font-bold text-white">PONTAZO <span class="text-cyan-400">BANK</span></h1>
                    <p class="text-lg text-slate-400 mt-2">Seu controle financeiro, simplificado.</p>
                </div>
                <div class="w-1/3 flex justify-end items-center gap-6">
                    <div id="notification-bell" class="notification-bell text-2xl text-slate-400 hover:text-white">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="notification-badge hidden">0</span>
                        <div id="notification-dropdown" class="notification-dropdown text-sm hidden"></div>
                    </div>
                    <button id="logout-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </header>

            <!-- Abas de Módulos -->
            <div class="mb-4 border-b border-slate-700">
                <nav id="module-tabs" class="flex -mb-px overflow-x-auto">
                    <button class="tab-btn" data-module="DASHBOARD">Dashboard</button>
                    <button class="tab-btn" data-module="CONTAS A PAGAR">Contas a Pagar</button>
                    <button class="tab-btn" data-module="PAGO">Pago</button>
                    <button class="tab-btn" data-module="EMPRESTIMOS">Empréstimos</button>
                    <button class="tab-btn" data-module="DESPESAS ADM MENSAIS">Despesas ADM</button>
                    <button class="tab-btn" data-module="FOLHA DE PAGAMENTO">Folha de Pagamento</button>
                    <button class="tab-btn" data-module="IMPOSTOS">Impostos</button>
                    <button class="tab-btn" data-module="CONTAS AVULSAS">Contas Avulsas</button>
                    <button id="admin-tab-btn" class="tab-btn hidden" data-module="ADMIN">Admin</button>
                </nav>
            </div>
            
            <!-- Filtros de Data e Exportação -->
            <div id="controls-section" class="flex flex-wrap justify-center items-center gap-4 mb-8">
                <div class="flex items-center gap-4">
                    <div>
                        <label for="year-filter" class="text-sm font-medium text-slate-400 mr-2">Ano:</label>
                        <select id="year-filter" class="filter-select"><option value="all">Todos</option></select>
                    </div>
                    <div>
                        <label for="month-filter" class="text-sm font-medium text-slate-400 mr-2">Mês:</label>
                        <select id="month-filter" class="filter-select" disabled>
                            <option value="all">Todos</option><option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option><option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option><option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option><option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
                        </select>
                    </div>
                </div>
                 <button id="manage-tags-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                    <i class="fas fa-tags"></i> Gerir Tags
                </button>
                <button id="export-csv-btn" class="bg-green-800 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-file-csv"></i> CSV
                </button>
                <button id="export-pdf-btn" class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            </div>

            <!-- Conteúdo Principal -->
            <main id="main-content">
                <!-- Cards de Resumo -->
                <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg">
                        <h2 id="total-value-title" class="text-slate-400 text-lg mb-2">Valor Total</h2>
                        <p id="total-value" class="text-3xl font-bold text-white">R$ 0,00</p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg">
                        <h2 id="pending-count-title" class="text-slate-400 text-lg mb-2">Total Pendente</h2>
                        <p id="pending-count" class="text-3xl font-bold text-red-500">0</p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg">
                        <h2 id="paid-count-title" class="text-slate-400 text-lg mb-2">Total Efetuado</h2>
                        <p id="paid-count" class="text-3xl font-bold text-green-500">0</p>
                    </div>
                </div>

                <!-- Seção de Gráficos (Apenas no Dashboard) -->
                <div id="charts-section" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="chart-container flex flex-col">
                        <h3 class="text-xl font-bold text-white mb-4 flex-shrink-0">Custos por Módulo</h3>
                        <div class="relative flex-grow"><canvas id="modules-chart"></canvas></div>
                    </div>
                    <div class="chart-container flex flex-col">
                        <h3 class="text-xl font-bold text-white mb-4 flex-shrink-0">Status de Pagamentos</h3>
                        <div class="relative flex-grow"><canvas id="status-chart"></canvas></div>
                    </div>
                    <div class="lg:col-span-2 chart-container flex flex-col">
                        <h3 class="text-xl font-bold text-white mb-4 flex-shrink-0">Custos por Tag (Top 10)</h3>
                        <div class="relative flex-grow"><canvas id="tags-chart"></canvas></div>
                    </div>
                </div>

                <!-- Conteúdo do Módulo (Tabela e Filtros) -->
                <div id="module-content" class="hidden">
                     <!-- Filtros Avançados e Pesquisa -->
                    <div class="flex flex-wrap gap-4 items-center mb-6 bg-slate-800 p-4 rounded-lg">
                        <div class="relative flex-grow">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-slate-500"></i></span>
                            <input type="text" id="search-input" placeholder="Pesquisar por descrição..." class="search-input w-full pl-10">
                        </div>
                        <select id="priority-filter" class="filter-select">
                            <option value="all">Todas Prioridades</option>
                            <option value="Alta">Alta</option><option value="Media">Média</option><option value="Baixa">Baixa</option>
                        </select>
                        <select id="payment-method-filter" class="filter-select">
                            <option value="all">Todas Formas</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option><option value="Débito">Débito</option><option value="PIX">PIX</option><option value="Dinheiro">Dinheiro</option>
                        </select>
                        <select id="tag-filter" class="filter-select">
                            <option value="all">Todas as Tags</option>
                        </select>
                        <div id="add-payment-container" class="relative">
                            <button id="add-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                <i class="fas fa-plus-circle"></i> Adicionar <i class="fas fa-caret-down ml-2"></i>
                            </button>
                            <div id="add-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-slate-700 rounded-md shadow-lg z-20">
                                <a href="#" id="add-payment-btn" class="block px-4 py-2 text-sm text-slate-200 hover:bg-slate-600">Novo Pagamento</a>
                                <a href="#" id="add-loan-btn" class="block px-4 py-2 text-sm text-slate-200 hover:bg-slate-600">Novo Empréstimo</a>
                            </div>
                        </div>
                    </div>

                    <div id="payments-view" class="bg-slate-800 rounded-2xl shadow-lg border border-slate-700 overflow-hidden">
                        <div class="table-responsive">
                            <table class="w-full text-left">
                                <thead class="bg-slate-700/50">
                                    <tr>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">Descrição</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">Tag</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">Valor</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider">Vencimento</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider text-center">Prioridade</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider text-center">Status</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider text-center">Autorização</th>
                                        <th class="p-4 text-sm font-semibold text-slate-300 uppercase tracking-wider text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="payment-table-body" class="divide-y divide-slate-700"></tbody>
                            </table>
                        </div>
                        <div id="empty-state" class="text-center p-12 text-slate-400">
                            <i class="fas fa-file-invoice-dollar fa-3x mb-4"></i>
                            <p class="font-semibold">Nenhum pagamento encontrado.</p>
                            <p>Tente ajustar os filtros ou adicione um novo pagamento.</p>
                        </div>
                         <!-- Controles de Paginação -->
                        <div id="pagination-controls" class="flex justify-center items-center gap-4 p-4 bg-slate-800 border-t border-slate-700">
                            <button id="prev-page-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Anterior</button>
                            <span id="page-info" class="text-slate-400">Página 1 de 1</span>
                            <button id="next-page-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Próximo</button>
                        </div>
                    </div>

                    <div id="loans-view" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Cards de Empréstimos serão inseridos aqui -->
                    </div>
                </div>

                 <!-- Painel de Administração -->
                <div id="admin-panel" class="hidden">
                    <h2 class="text-3xl font-bold text-white mb-6">Painel de Administração</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Gerir Empresas -->
                        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">Gerir Empresas</h3>
                            <form id="add-company-form" class="flex gap-2 mb-4">
                                <input type="text" id="new-company-name" placeholder="Nome da nova empresa" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3" required>
                                <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Adicionar</button>
                            </form>
                            <div id="company-list" class="space-y-2"></div>
                        </div>

                        <!-- Gerir Utilizadores Estáticos -->
                        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">Gerir Utilizadores</h3>
                            <form id="add-user-form" class="space-y-4 mb-4">
                                <input type="text" id="new-user-username" placeholder="Nome de utilizador" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3" required>
                                <input type="password" id="new-user-password" placeholder="Senha" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3" required>
                                <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Criar Utilizador</button>
                            </form>
                            <div id="user-list" class="space-y-2"></div>
                        </div>

                        <!-- Log de Atividades -->
                        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">Log de Atividades</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="date" id="log-date-filter" class="filter-select w-full">
                                <button id="view-log-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg w-full">Ver Log</button>
                            </div>
                            <p class="text-sm text-slate-400">Veja o histórico de ações importantes realizadas no sistema.</p>
                        </div>

                        <!-- Backup e Restauro -->
                        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                            <h3 class="text-xl font-bold text-cyan-400 mb-4">Backup e Restauro</h3>
                            <button id="generate-backup-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg mb-4">Gerar Backup da Empresa</button>
                            <div class="text-center">
                                <label for="restore-backup-input" class="w-full bg-gray-600 cursor-not-allowed text-white font-bold py-2 px-4 rounded-lg opacity-50">
                                    Restaurar Backup
                                </label>
                                <input type="file" id="restore-backup-input" class="hidden" disabled>
                                 <p class="text-xs text-slate-400 mt-2">A funcionalidade de restauro estará disponível em breve.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <footer class="text-center py-6 mt-10 border-t border-slate-800">
                <p class="text-sm text-slate-400">
                    CRIADO POR: RAMILES SILVA – 
                    <a href="https://www.ramilesdev.com" target="_blank" rel="noopener noreferrer" class="font-medium text-cyan-400 hover:text-cyan-300 transition-colors">
                        www.ramilesdev.com
                    </a>
                    <span class="mx-2">|</span>
                    <a href="mailto:ramires3712@gmail.com" class="font-medium text-cyan-400 hover:text-cyan-300 transition-colors">
                        ramires3712@gmail.com
                    </a>
                </p>
            </footer>

        </div>
    </div>

    <!-- Modal para Adicionar/Editar Pagamento -->
    <div id="payment-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-2xl mx-auto rounded-2xl shadow-2xl border border-slate-700">
                <form id="payment-form" class="p-8 space-y-6">
                    <h2 id="modal-title" class="text-2xl font-bold mb-6 text-white">Adicionar Novo Pagamento</h2>
                    <input type="hidden" id="payment-id" name="payment-id">
                    
                    <div>
                        <label for="description" class="block text-sm font-medium text-slate-300 mb-2">Descrição</label>
                        <input type="text" id="description" name="description" placeholder="Ex: Conta de Luz" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="date" class="block text-sm font-medium text-slate-300 mb-2">Data Lançamento</label>
                            <input type="date" id="date" name="date" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        </div>
                        <div>
                            <label for="dueDate" class="block text-sm font-medium text-slate-300 mb-2">Data Vencimento</label>
                            <input type="date" id="dueDate" name="dueDate" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="value" class="block text-sm font-medium text-slate-300 mb-2">Valor (R$)</label>
                            <input type="text" id="value" name="value" placeholder="18.662,58" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        </div>
                        <div>
                            <label for="payment-method" class="block text-sm font-medium text-slate-300 mb-2">Forma de Pagamento</label>
                            <select id="payment-method" name="payment-method" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <option value="Cartão de Crédito">Cartão de Crédito</option> <option value="Débito">Débito</option> <option value="PIX">PIX</option> <option value="Dinheiro">Dinheiro</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="module" class="block text-sm font-medium text-slate-300 mb-2">Módulo</label>
                            <select id="module" name="module" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <option value="DESPESAS ADM MENSAIS">Despesas ADM Mensais</option> <option value="FOLHA DE PAGAMENTO">Folha de Pagamento</option> <option value="IMPOSTOS">Impostos</option> <option value="CONTAS AVULSAS">Contas Avulsas</option>
                            </select>
                        </div>
                        <div>
                            <label for="priority" class="block text-sm font-medium text-slate-300 mb-2">Prioridade</label>
                            <select id="priority" name="priority" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <option value="Baixa">Baixa</option> <option value="Media">Média</option> <option value="Alta">Alta</option>
                            </select>
                        </div>
                    </div>

                     <!-- Campo de Tags -->
                    <div>
                        <label for="tags-select" class="block text-sm font-medium text-slate-300 mb-2">Tag</label>
                        <select id="tags-select" name="tag" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="">Nenhuma</option>
                            <!-- Opções de tags serão inseridas aqui -->
                        </select>
                    </div>
                    
                    <!-- Recurring Payment Section -->
                    <div id="recurring-payment-section">
                        <div class="border-t border-slate-700 my-6"></div>
                        <div>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" id="recurring-payment-checkbox" class="w-5 h-5 bg-slate-700 border-slate-600 rounded text-cyan-500 focus:ring-cyan-500">
                                <span class="text-slate-300">Lançar como Pagamento Recorrente / Parcelado</span>
                            </label>
                        </div>
                        <div id="installments-container" class="hidden mt-4">
                            <label for="installments" class="block text-sm font-medium text-slate-300 mb-2">Número de Parcelas</label>
                            <input type="number" id="installments" name="installments" min="2" placeholder="Ex: 12" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="attachment" class="block text-sm font-medium text-slate-300 mb-2">Anexar Comprovativo</label>
                            <input type="file" id="attachment" name="attachment" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-50 file:text-cyan-700 hover:file:bg-cyan-100">
                        </div>
                        <div>
                            <label for="status" class="block text-sm font-medium text-slate-300 mb-2">Status</label>
                            <select id="status" name="status" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                                <option value="Pendente">Pendente</option> <option value="Pago">Pago</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition">Cancelar</button>
                        <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionar Empréstimo -->
    <div id="loan-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-2xl mx-auto rounded-2xl shadow-2xl border border-slate-700">
                <form id="loan-form" class="p-8 space-y-6">
                    <h2 class="text-2xl font-bold mb-6 text-white">Adicionar Novo Empréstimo</h2>
                    <div>
                        <label for="loan-description" class="block text-sm font-medium text-slate-300 mb-2">Descrição</label>
                        <input type="text" id="loan-description" name="loan-description" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3" required>
                    </div>
                    <div class="border-t border-slate-700 pt-6">
                        <h3 class="text-lg font-semibold text-cyan-400 mb-4">Parâmetros e Taxas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div>
                                <label for="loan-amount" class="block text-sm font-medium text-slate-300 mb-2">Valor da Proposta (R$)</label>
                                <input type="text" id="loan-amount" name="loan-amount" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3" required>
                            </div>
                            <div>
                                <label for="loan-installments" class="block text-sm font-medium text-slate-300 mb-2">Prazo (Meses)</label>
                                <input type="number" id="loan-installments" name="loan-installments" min="1" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3" required>
                            </div>
                            <div>
                                <label for="loan-grace-period" class="block text-sm font-medium text-slate-300 mb-2">Carência (Meses)</label>
                                <input type="number" id="loan-grace-period" name="loan-grace-period" min="0" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3" required>
                            </div>
                            <div>
                                <label for="loan-iof" class="block text-sm font-medium text-slate-300 mb-2">Valor IOF (R$)</label>
                                <input type="text" id="loan-iof" name="loan-iof" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3">
                            </div>
                             <div>
                                <label for="loan-tac" class="block text-sm font-medium text-slate-300 mb-2">Valor TAC (R$)</label>
                                <input type="text" id="loan-tac" name="loan-tac" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3">
                            </div>
                            <div>
                                <label for="loan-cet" class="block text-sm font-medium text-slate-300 mb-2">CET (% a.m.)</label>
                                <input type="text" id="loan-cet" name="loan-cet" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3">
                            </div>
                             <div>
                                <label for="loan-nominal-interest" class="block text-sm font-medium text-slate-300 mb-2">Juros Nominais (% a.m.)</label>
                                <input type="text" id="loan-nominal-interest" name="loan-nominal-interest" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3">
                            </div>
                            <div>
                                <label for="loan-other-charges" class="block text-sm font-medium text-slate-300 mb-2">Outros Encargos (% a.m.)</label>
                                <input type="text" id="loan-other-charges" name="loan-other-charges" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3">
                            </div>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="loan-start-date" class="block text-sm font-medium text-slate-300 mb-2">Data da 1ª Parcela</label>
                            <input type="date" id="loan-start-date" name="loan-start-date" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3" required>
                        </div>
                        <div>
                            <label for="loan-tag" class="block text-sm font-medium text-slate-300 mb-2">Tag</label>
                            <select id="loan-tag" name="loan-tag" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3">
                                <option value="">Nenhuma</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-loan-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">Gerar Parcelas</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Gestão de Tags -->
    <div id="manage-tags-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-lg mx-auto rounded-2xl shadow-2xl border border-slate-700">
                <div class="p-8">
                    <h2 class="text-2xl font-bold mb-6 text-white">Gerir Tags</h2>
                    <form id="add-tag-form" class="flex gap-2 mb-4">
                        <input type="text" id="new-tag-name" placeholder="Nome da nova tag" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none" required>
                        <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg">Adicionar</button>
                    </form>
                    <div id="tags-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Lista de tags será inserida aqui -->
                    </div>
                    <div class="flex justify-end mt-8">
                        <button type="button" id="close-tags-modal-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition">Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Ação -->
    <div id="confirm-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-md mx-auto rounded-2xl shadow-2xl border border-slate-700 p-8 text-center">
                <h3 id="confirm-title" class="text-xl font-bold text-white mb-4">Confirmar Ação</h3>
                <p id="confirm-text" class="text-slate-300 mb-8"></p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-confirm-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition">Cancelar</button>
                    <button id="confirm-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gestão de Permissões de Utilizador -->
    <div id="user-permissions-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-4xl mx-auto rounded-2xl shadow-2xl border border-slate-700">
                <form id="user-permissions-form" class="p-8">
                    <h2 id="user-permissions-title" class="text-2xl font-bold mb-6 text-white">Gerir Permissões</h2>
                    <input type="hidden" id="permission-username">
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-1">
                            <h3 class="text-lg font-semibold text-cyan-400 mb-4 border-b border-slate-700 pb-2">Empresas Acessíveis</h3>
                            <div id="permissions-company-list" class="space-y-3"></div>
                        </div>
                        <div class="md:col-span-2">
                             <h3 class="text-lg font-semibold text-cyan-400 mb-4 border-b border-slate-700 pb-2">Ações Permitidas</h3>
                            <div id="permissions-action-list" class="space-y-4"></div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 pt-8 mt-8 border-t border-slate-700">
                        <button type="button" id="cancel-permissions-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition">Cancelar</button>
                        <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition">Salvar Permissões</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="whatsapp-notifications-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-lg mx-auto rounded-2xl shadow-2xl border border-slate-700">
                <form id="whatsapp-notifications-form" class="p-8">
                    <h2 id="whatsapp-notifications-title" class="text-2xl font-bold mb-6 text-white">Configurar Notificações do WhatsApp</h2>
                    <input type="hidden" id="whatsapp-username">
                    
                    <div class="space-y-6">
                        <div>
                            <label for="whatsapp-number" class="block text-sm font-medium text-slate-300 mb-2">Número de WhatsApp</label>
                            <input type="text" id="whatsapp-number" placeholder="Ex: 5511912345678" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <p class="text-xs text-slate-400 mt-1">Inclua o código do país (ex: 55 para o Brasil).</p>
                        </div>

                        <div>
                            <h3 class="text-md font-semibold text-slate-300 mb-3">Tipos de Alerta</h3>
                            <div class="space-y-3">
                                <label for="whatsapp-notify-upcoming" class="flex items-center space-x-3 text-slate-300 cursor-pointer">
                                    <input type="checkbox" id="whatsapp-notify-upcoming" value="upcoming" class="w-4 h-4 bg-slate-700 border-slate-600 rounded text-cyan-500 focus:ring-cyan-500">
                                    <span>Avisar sobre contas a vencer</span>
                                </label>
                                <label for="whatsapp-notify-overdue" class="flex items-center space-x-3 text-slate-300 cursor-pointer">
                                    <input type="checkbox" id="whatsapp-notify-overdue" value="overdue" class="w-4 h-4 bg-slate-700 border-slate-600 rounded text-cyan-500 focus:ring-cyan-500">
                                    <span>Avisar sobre contas vencidas</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-4 pt-8 mt-8 border-t border-slate-700">
                        <button type="button" id="cancel-whatsapp-notifications-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition">Cancelar</button>
                        <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition">Salvar Configurações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for Audit Log -->
    <div id="audit-log-modal" class="modal-backdrop">
        <div class="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div class="modal-content bg-slate-800 w-full max-w-4xl mx-auto rounded-2xl shadow-2xl border border-slate-700">
                <div class="p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white">Log de Atividades</h2>
                        <button id="close-audit-log-btn" class="text-slate-400 hover:text-white">&times;</button>
                    </div>
                    <div id="audit-log-content" class="max-h-[60vh] overflow-y-auto pr-4">
                        <!-- Log entries will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            const app = new App();
            app.init();
        });

        // --- CLASSE PRINCIPAL DA APLICAÇÃO ---
        class App {
            constructor() {
                this.ui = this.getUIElements();
                this.state = this.getInitialState();
                this.supabase = supabase.createClient('https://cykvtziwulnqgyyaeugj.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5a3Z0eml3dWxucWd5eWFldWdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzODkyMTcsImV4cCI6MjA2Njk2NTIxN30.fbSC1VOp0OT7TKnGAgwbaiqPEAMUty4bfgRN6esCLZo');
            }

            // --- SETUP ---
            getUIElements() {
                const elementIds = [
                    'loading-overlay', 'login-screen', 'app-container', 'login-form', 'login-error', 'company-selector', 'logout-btn', 'controls-section',
                    'summary-cards', 'charts-section', 'export-pdf-btn', 'export-csv-btn', 'add-btn', 'add-dropdown', 'add-payment-btn', 'add-loan-btn', 'payment-modal',
                    'payment-form', 'cancel-btn', 'payment-table-body', 'modal-title', 'payment-id', 'empty-state', 'module-tabs', 'module-content',
                    'year-filter', 'month-filter', 'search-input', 'priority-filter', 'payment-method-filter', 'tag-filter', 'notification-bell',
                    'notification-badge', 'notification-dropdown', 'confirm-modal', 'confirm-title', 'confirm-text', 'confirm-btn', 'cancel-confirm-btn',
                    'pagination-controls', 'prev-page-btn', 'next-page-btn', 'page-info', 'tags-select', 'manage-tags-btn', 'manage-tags-modal',
                    'close-tags-modal-btn', 'add-tag-form', 'new-tag-name', 'tags-list', 'payments-view', 'loans-view', 'loan-modal',
                    'loan-form', 'cancel-loan-btn', 'recurring-payment-section', 'recurring-payment-checkbox', 'installments-container', 'installments',
                    'admin-tab-btn', 'admin-panel', 'add-company-form', 'company-list', 'add-user-form', 'user-list', 'user-permissions-modal',
                    'user-permissions-form', 'user-permissions-title', 'permissions-company-list', 'permissions-action-list', 'cancel-permissions-btn',
                    'permission-username', 'loan-tag', 'total-value', 'pending-count', 'paid-count', 'total-value-title', 'pending-count-title', 'paid-count-title',
                    'new-user-username', 'new-user-password', 'username', 'password', 'new-company-name',
                    'whatsapp-notifications-modal', 'whatsapp-notifications-form', 'whatsapp-notifications-title', 'whatsapp-username',
                    'whatsapp-number', 'whatsapp-notify-upcoming', 'whatsapp-notify-overdue', 'cancel-whatsapp-notifications-btn',
                    'log-date-filter', 'view-log-btn', 'audit-log-modal', 'close-audit-log-btn', 'audit-log-content',
                    'generate-backup-btn', 'restore-backup-input'
                ];
                const ui = {};
                for (const id of elementIds) {
                    const el = document.getElementById(id);
                    if (el) {
                        const camelCaseId = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                        ui[camelCaseId] = el;
                    } else {
                        console.warn(`Element with ID "${id}" not found.`);
                    }
                }
                return ui;
            }

            getInitialState() {
                return {
                    currentModule: 'DASHBOARD', allPayments: [], allTags: [],
                    moduleNames: ["DESPESAS ADM MENSAIS", "FOLHA DE PAGAMENTO", "IMPOSTOS", "CONTAS AVULSAS", "EMPRESTIMOS"],
                    modulesChartInstance: null, statusChartInstance: null, tagsChartInstance: null,
                    selectedYear: 'all', selectedMonth: 'all', searchTerm: '', selectedPriority: 'all', selectedPaymentMethod: 'all', selectedTag: 'all',
                    actionToConfirm: null, currentPage: 1, itemsPerPage: 50, totalItems: 0,
                    currentUser: null, allSystemCompanies: [], staticUsers: [], currentCompanyId: null,
                };
            }

            init() {
                this.ui.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
            }

            async handleLogin(e) {
                e.preventDefault();
                this.showLoader();
                const username = this.ui.username.value;
                const password = this.ui.password.value;
                
                await this.loadStaticUsers();

                const adminUser = {
                    username: 'ramiles.silva', password: 'gtasana3614U#', isSuperAdmin: true, permissions: [], companies: []
                };
                const normalUser = {
                    username: 'pontazobank', password: 'pontazobank@2025', isSuperAdmin: false,
                    permissions: ['create_payment', 'edit_payment', 'authorize_payment', 'pay_payment', 'create_loan', 'delete_loan', 'manage_tags'],
                    companies: [1, 2]
                };

                const users = [adminUser, normalUser, ...this.state.staticUsers];
                const foundUser = users.find(u => u.username === username && u.password === password);

                if (foundUser) {
                    this.state.currentUser = foundUser;
                    await this.logAction('Login', { success: true });
                    this.ui.loginScreen.style.display = 'none';
                    this.ui.appContainer.classList.remove('hidden');
                    this.initializeMainApp();
                } else {
                    await this.logAction('Login Failed', { username: username });
                    this.ui.loginError.textContent = 'Utilizador ou senha inválidos.';
                    this.hideLoader();
                }
            }

            async initializeMainApp() {
                this.showLoader();
                this.populateYearFilter(); // CORREÇÃO: Adicionada chamada para popular o filtro de ano
                await this.populateCompanySelector();
                await this.fetchTags();
                this.applyFilters();
                this.addEventListeners();
                this.hideLoader();
            }
            
            showLoader() { this.ui.loadingOverlay.style.display = 'flex'; }
            hideLoader() { this.ui.loadingOverlay.style.display = 'none'; }
            formatCurrency(value) { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); }
            formatDate(dateString, includeTime = false) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' }; // Adicionado timeZone para consistência
                if (includeTime) {
                    options.hour = '2-digit';
                    options.minute = '2-digit';
                    options.second = '2-digit';
                }
                return new Intl.DateTimeFormat('pt-BR', options).format(date);
            }
            parseCurrency(valueString) {
                if (typeof valueString !== 'string') return NaN;
                return parseFloat(valueString.replace(/\./g, '').replace(',', '.'));
            }
            stringToColor(str) {
                let hash = 0;
                if (!str) return '#64748b';
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                const h = hash % 360;
                return `hsla(${h}, 70%, 70%, 1)`;
            }

            hasPermission(permission) {
                if (this.state.currentUser?.isSuperAdmin) return true;
                return this.state.currentUser?.permissions?.includes(permission);
            }

            checkPermissions() {
                document.querySelectorAll('[data-permission]').forEach(el => {
                    const requiredPermission = el.dataset.permission;
                    el.style.display = this.hasPermission(requiredPermission) ? '' : 'none';
                });
            }
            
            async loadStaticUsers() {
                const { data, error } = await this.supabase.from('static_users').select('*');
                if (error) {
                    console.error("Erro ao carregar utilizadores estáticos:", error);
                    this.state.staticUsers = [];
                } else {
                    this.state.staticUsers = data;
                }
            }

            async populateCompanySelector() {
                const { data, error } = await this.supabase.from('companies').select('*').order('name');
                if (error) {
                    console.error("Erro ao buscar empresas:", error);
                    return;
                }
                this.state.allSystemCompanies = data;
                
                let companiesToDisplay = [];
                if (this.state.currentUser.isSuperAdmin) {
                    companiesToDisplay = this.state.allSystemCompanies;
                } else {
                    companiesToDisplay = this.state.allSystemCompanies.filter(c => this.state.currentUser.companies.includes(c.id));
                }

                this.ui.companySelector.innerHTML = '';
                companiesToDisplay.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.name;
                    this.ui.companySelector.appendChild(option);
                });

                if (companiesToDisplay.length > 0) {
                    this.state.currentCompanyId = companiesToDisplay[0].id;
                    this.ui.companySelector.value = this.state.currentCompanyId;
                } else {
                    this.state.currentCompanyId = null;
                }
            }
            
            // CORREÇÃO: Nova função para popular o seletor de ano
            populateYearFilter() {
                const currentYear = new Date().getFullYear();
                this.ui.yearFilter.innerHTML = '<option value="all">Todos</option>'; // Limpa opções existentes
                for (let i = currentYear + 1; i >= currentYear - 5; i--) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    this.ui.yearFilter.appendChild(option);
                }
            }


            async fetchPaginatedPayments() {
                if (!this.state.currentCompanyId) {
                    this.state.allPayments = [];
                    this.state.totalItems = 0;
                    this.updateUI();
                    return;
                }
                this.showLoader();
                let query = this.supabase.from('payments').select('*', { count: 'exact' }).eq('company_id', this.state.currentCompanyId);

                if (this.state.currentModule === 'PAGO') {
                    query = query.eq('status', 'Pago');
                } else if (this.state.currentModule === 'CONTAS A PAGAR') {
                    query = query.eq('status', 'Pendente');
                } else if (this.state.currentModule !== 'DASHBOARD' && this.state.currentModule !== 'EMPRESTIMOS' && this.state.currentModule !== 'ADMIN') {
                    query = query.eq('module', this.state.currentModule);
                }

                if (this.state.searchTerm) query = query.ilike('description', `%${this.state.searchTerm}%`);
                if (this.state.selectedPriority !== 'all') query = query.eq('priority', this.state.selectedPriority);
                if (this.state.selectedPaymentMethod !== 'all') query = query.eq('paymentMethod', this.state.selectedPaymentMethod);
                if (this.state.selectedTag !== 'all') query = query.eq('tag', this.state.selectedTag);
                
                // CORREÇÃO: Lógica de filtro de data ajustada para usar 'dueDate'
                if (this.state.selectedYear !== 'all') {
                    if (this.state.selectedMonth !== 'all') {
                        const monthStartDate = new Date(this.state.selectedYear, this.state.selectedMonth, 1).toISOString().slice(0,10);
                        const monthEndDate = new Date(this.state.selectedYear, parseInt(this.state.selectedMonth) + 1, 0).toISOString().slice(0,10);
                        query = query.gte('dueDate', monthStartDate).lte('dueDate', monthEndDate);
                    } else {
                        const startDate = `${this.state.selectedYear}-01-01`;
                        const endDate = `${this.state.selectedYear}-12-31`;
                        query = query.gte('dueDate', startDate).lte('dueDate', endDate);
                    }
                }

                const from = (this.state.currentPage - 1) * this.state.itemsPerPage;
                const to = from + this.state.itemsPerPage - 1;
                query = query.range(from, to).order('dueDate', { ascending: true });

                const { data, error, count } = await query;
                this.hideLoader();

                if (error) {
                    console.error('Erro ao buscar pagamentos:', error);
                    return;
                }

                this.state.allPayments = data;
                this.state.totalItems = count;
                this.updateUI();
            }

            async fetchAllFilteredDataForDashboard() {
                if (!this.state.currentCompanyId) return [];
                this.showLoader();
                let query = this.supabase.from('payments').select('*').eq('company_id', this.state.currentCompanyId);
                
                // CORREÇÃO: Lógica de filtro de data ajustada para usar 'dueDate'
                if (this.state.selectedYear !== 'all') {
                    if (this.state.selectedMonth !== 'all') {
                        const monthStartDate = new Date(this.state.selectedYear, this.state.selectedMonth, 1).toISOString().slice(0,10);
                        const monthEndDate = new Date(this.state.selectedYear, parseInt(this.state.selectedMonth) + 1, 0).toISOString().slice(0,10);
                        query = query.gte('dueDate', monthStartDate).lte('dueDate', monthEndDate);
                    } else {
                        const startDate = `${this.state.selectedYear}-01-01`;
                        const endDate = `${this.state.selectedYear}-12-31`;
                        query = query.gte('dueDate', startDate).lte('dueDate', endDate);
                    }
                }
                const { data, error } = await query;
                this.hideLoader();
                if (error) {
                    console.error('Erro ao buscar dados para o dashboard:', error);
                    return [];
                }
                return data;
            }
            
            async fetchTags() {
                if (!this.state.currentCompanyId) return;
                const { data, error } = await this.supabase.from('tags').select('id, name').eq('company_id', this.state.currentCompanyId).order('name');
                if (error) { console.error('Erro ao buscar tags:', error); return; }
                this.state.allTags = data;
                this.populateTagFilter();
                this.renderTagsInManageModal();
                this.populateTagsInPaymentModal();
            }

            populateTagFilter() {
                this.ui.tagFilter.innerHTML = '<option value="all">Todas as Tags</option>';
                this.state.allTags.forEach(tag => this.ui.tagFilter.add(new Option(tag.name, tag.name)));
            }
            
            populateTagsInPaymentModal() {
                this.ui.tagsSelect.innerHTML = '<option value="">Nenhuma</option>';
                this.state.allTags.forEach(tag => {
                    this.ui.tagsSelect.add(new Option(tag.name, tag.name));
                });
                this.ui.loanTag.innerHTML = '<option value="">Nenhuma</option>';
                this.state.allTags.forEach(tag => this.ui.loanTag.add(new Option(tag.name, tag.name)));
            }

            renderTagsInManageModal() {
                this.ui.tagsList.innerHTML = '';
                this.state.allTags.forEach(tag => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 bg-slate-700 rounded';
                    div.textContent = tag.name;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '&times;';
                    deleteBtn.className = 'ml-4 text-red-400 hover:text-red-200 font-bold text-xl';
                    deleteBtn.onclick = () => {
                        this.state.actionToConfirm = async () => {
                            this.showLoader();
                            await this.logAction('Delete Tag', { tagName: tag.name });
                            const { error } = await this.supabase.from('tags').delete().eq('id', tag.id);
                            if (error) console.error("Erro ao excluir tag:", error);
                            this.fetchTags();
                            this.hideLoader();
                        };
                        this.ui.confirmTitle.textContent = 'Confirmar Exclusão';
                        this.ui.confirmText.textContent = `Tem a certeza que deseja excluir a tag "${tag.name}"?`;
                        this.ui.confirmModal.style.display = 'flex';
                    };
                    div.appendChild(deleteBtn);
                    this.ui.tagsList.appendChild(div);
                });
            }

            openModal(type) {
                if (type === 'payment') this.ui.paymentModal.style.display = 'flex';
                else if (type === 'loan') this.ui.loanModal.style.display = 'flex';
            }
            
            closeModal(type) {
                if (type === 'payment') {
                    this.ui.paymentModal.style.display = 'none';
                    this.ui.paymentForm.reset();
                    this.ui.paymentId.value = '';
                    this.ui.modalTitle.textContent = 'Adicionar Novo Pagamento';
                    this.ui.recurringPaymentCheckbox.checked = false;
                    this.ui.installmentsContainer.classList.add('hidden');
                    this.ui.installments.value = '';
                } else if (type === 'loan') {
                    this.ui.loanModal.style.display = 'none';
                    this.ui.loanForm.reset();
                }
            }
            
            applyFilters() {
                this.state.currentPage = 1; 
                this.state.selectedYear = this.ui.yearFilter.value;
                this.state.selectedMonth = this.ui.monthFilter.value;
                this.state.searchTerm = this.ui.searchInput.value;
                this.state.selectedPriority = this.ui.priorityFilter.value;
                this.state.selectedPaymentMethod = this.ui.paymentMethodFilter.value;
                this.state.selectedTag = this.ui.tagFilter.value;
                this.ui.monthFilter.disabled = this.state.selectedYear === 'all';
                
                if(this.state.currentModule === 'DASHBOARD' || this.state.currentModule === 'ADMIN') {
                    this.updateUI();
                } else if (this.state.currentModule === 'EMPRESTIMOS') {
                    this.updateUI();
                }
                else {
                    this.fetchPaginatedPayments();
                }
            }

            async updateNotifications() {
                if (!this.state.currentCompanyId) return;
                const today = new Date().toISOString().slice(0, 10);
                const sevenDaysFromNow = new Date();
                sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
                const sevenDaysISO = sevenDaysFromNow.toISOString().slice(0, 10);

                const { data: overdue, error: overdueError } = await this.supabase.from('payments').select('description, dueDate').eq('company_id', this.state.currentCompanyId).eq('status', 'Pendente').lt('dueDate', today);
                const { data: upcoming, error: upcomingError } = await this.supabase.from('payments').select('description, dueDate').eq('company_id', this.state.currentCompanyId).eq('status', 'Pendente').gte('dueDate', today).lte('dueDate', sevenDaysISO);
                
                if(overdueError || upcomingError) { console.error('Erro ao buscar notificações'); return; }

                const totalNotifications = overdue.length + upcoming.length;
                this.ui.notificationDropdown.innerHTML = '';

                if (totalNotifications > 0) {
                    this.ui.notificationBadge.textContent = totalNotifications;
                    this.ui.notificationBadge.classList.remove('hidden');
                    if (overdue.length > 0) {
                        this.ui.notificationDropdown.innerHTML += `<div class="p-2 font-bold text-red-400 border-b border-slate-600">Vencidas (${overdue.length})</div>`;
                        overdue.forEach(p => this.ui.notificationDropdown.innerHTML += `<div class="p-2 border-b border-slate-700"><strong>${p.description}</strong><br><span class="text-xs text-slate-400">Venceu em: ${this.formatDate(p.dueDate)}</span></div>`);
                    }
                    if (upcoming.length > 0) {
                        this.ui.notificationDropdown.innerHTML += `<div class="p-2 font-bold text-amber-400 border-b border-slate-600">A Vencer (${upcoming.length})</div>`;
                        upcoming.forEach(p => this.ui.notificationDropdown.innerHTML += `<div class="p-2 border-b border-slate-700"><strong>${p.description}</strong><br><span class="text-xs text-slate-400">Vence em: ${this.formatDate(p.dueDate)}</span></div>`);
                    }
                } else {
                    this.ui.notificationBadge.classList.add('hidden');
                    this.ui.notificationDropdown.innerHTML = `<div class="p-4 text-center text-slate-400">Nenhuma notificação.</div>`;
                }
            }
            
            async updateUI() {
                this.updateActiveTab();
                
                const mainSections = [this.ui.summaryCards, this.ui.chartsSection, this.ui.moduleContent, this.ui.adminPanel];
                mainSections.forEach(s => s.style.display = 'none');
                this.ui.controlsSection.style.display = 'flex';

                if (this.state.currentModule === 'DASHBOARD') {
                    this.ui.summaryCards.style.display = 'grid';
                    this.ui.chartsSection.style.display = 'grid';
                    const dashboardData = await this.fetchAllFilteredDataForDashboard();
                    this.updateDashboard(dashboardData);
                } else if (this.state.currentModule === 'ADMIN') {
                    this.ui.controlsSection.style.display = 'none';
                    this.ui.adminPanel.style.display = 'block';
                    this.renderAdminPanel();
                } else if (this.state.currentModule === 'EMPRESTIMOS') {
                    this.ui.summaryCards.style.display = 'grid';
                    this.ui.moduleContent.style.display = 'block';
                    this.ui.paymentsView.style.display = 'none';
                    this.ui.loansView.style.display = 'grid';
                    this.renderLoans();
                } else {
                    this.ui.summaryCards.style.display = 'grid';
                    this.ui.moduleContent.style.display = 'block';
                    this.ui.paymentsView.style.display = 'block';
                    this.ui.loansView.style.display = 'none';
                    this.renderTable(this.state.allPayments);
                    this.updateModuleSummary(this.state.allPayments);
                    this.updatePaginationControls();
                }

                this.ui.adminTabBtn.style.display = this.state.currentUser.isSuperAdmin ? 'block' : 'none';
                this.checkPermissions();
                this.updateNotifications();
            }

            updatePaginationControls() {
                const totalPages = Math.ceil(this.state.totalItems / this.state.itemsPerPage);
                this.ui.pageInfo.textContent = `Página ${this.state.currentPage} de ${totalPages || 1}`;
                this.ui.prevPageBtn.disabled = this.state.currentPage === 1;
                this.ui.nextPageBtn.disabled = this.state.currentPage === totalPages || totalPages === 0;
            }

            updateDashboard(payments) {
                const totalValue = payments.reduce((sum, p) => sum + p.value, 0);
                const totalPendingValue = payments.filter(p => p.status === 'Pendente').reduce((sum, p) => sum + p.value, 0);
                const totalPaidValue = payments.filter(p => p.status === 'Pago').reduce((sum, p) => sum + p.value, 0);
                this.ui.totalValue.textContent = this.formatCurrency(totalValue);
                this.ui.pendingCount.textContent = this.formatCurrency(totalPendingValue);
                this.ui.paidCount.textContent = this.formatCurrency(totalPaidValue);
                this.renderModulesChart(payments);
                this.renderStatusChart(payments);
                this.renderTagsChart(payments);
            }
            
            renderModulesChart(payments) {
                const ctx = document.getElementById('modules-chart').getContext('2d');
                const data = {
                    labels: this.state.moduleNames,
                    datasets: [{
                        label: 'Custo Total',
                        data: this.state.moduleNames.map(module => payments.filter(p => p.module === module).reduce((sum, p) => sum + p.value, 0)),
                        backgroundColor: ['#06b6d4', '#0891b2', '#0e7490', '#155e75', '#164e63'],
                        borderColor: '#1e293b', borderWidth: 2, borderRadius: 5,
                    }]
                };
                if (this.state.modulesChartInstance) this.state.modulesChartInstance.destroy();
                this.state.modulesChartInstance = new Chart(ctx, {
                    type: 'bar', data: data,
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => this.formatCurrency(c.parsed.x) } } },
                        scales: { y: { ticks: { color: '#94a3b8' }, grid: { display: false } }, x: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' }, title: { display: true, text: 'Valor (R$)', color: '#94a3b8' } } }
                    }
                });
            }
            
            renderStatusChart(payments) {
                const ctx = document.getElementById('status-chart').getContext('2d');
                const paidValue = payments.filter(p => p.status === 'Pago').reduce((sum, p) => sum + p.value, 0);
                const pendingValue = payments.filter(p => p.status === 'Pendente').reduce((sum, p) => sum + p.value, 0);
                const data = {
                    labels: ['Pago', 'Pendente'],
                    datasets: [{ data: [paidValue, pendingValue], backgroundColor: ['#10B981', '#EF4444'], borderColor: '#1e293b', borderWidth: 4 }]
                };
                if (this.state.statusChartInstance) this.state.statusChartInstance.destroy();
                this.state.statusChartInstance = new Chart(ctx, {
                    type: 'doughnut', data: data,
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '70%',
                        plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${this.formatCurrency(c.parsed)}` } } }
                    }
                });
            }

            renderTagsChart(payments) {
                const ctx = document.getElementById('tags-chart').getContext('2d');
                const tagsData = {};
                payments.forEach(p => {
                    if (p.tag) {
                        if (!tagsData[p.tag]) tagsData[p.tag] = 0;
                        tagsData[p.tag] += p.value;
                    }
                });
                
                const sortedTags = Object.entries(tagsData).sort(([,a],[,b]) => b-a).slice(0, 10);
                const labels = sortedTags.map(item => item[0]);
                const dataValues = sortedTags.map(item => item[1]);

                const data = {
                    labels: labels,
                    datasets: [{
                        label: 'Custo por Tag',
                        data: dataValues,
                        backgroundColor: labels.map(label => this.stringToColor(label)),
                        borderColor: '#1e293b', borderWidth: 4
                    }]
                };
                if (this.state.tagsChartInstance) this.state.tagsChartInstance.destroy();
                this.state.tagsChartInstance = new Chart(ctx, {
                    type: 'doughnut', data: data,
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '70%',
                        plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } }, tooltip: { callbacks: { label: (c) => `${c.label}: ${this.formatCurrency(c.parsed)}` } } }
                    }
                });
            }

            updateModuleSummary(payments) {
                const totalValue = payments.reduce((sum, p) => sum + p.value, 0);
                const pendingCount = payments.filter(p => p.status === 'Pendente').length;
                const paidCount = payments.length - pendingCount;
                this.ui.totalValue.textContent = this.formatCurrency(totalValue);
                this.ui.pendingCount.textContent = pendingCount;
                this.ui.paidCount.textContent = paidCount;
            }

            renderTable(payments) {
                this.ui.paymentTableBody.innerHTML = '';
                this.ui.emptyState.style.display = payments.length === 0 ? 'block' : 'none';
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                payments.forEach(p => {
                    const isOverdue = p.status === 'Pendente' && new Date(p.dueDate) < today;
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-700/50 transition-colors';
                    const tagHtml = p.tag ? `<span class="tag-badge" style="background-color: ${this.stringToColor(p.tag)}20; color: ${this.stringToColor(p.tag)};">${p.tag}</span>` : '';

                    const authorizationStatus = p.authorization_status || 'Pendente';
                    let authorizationBadgeClass = 'status-autorizacao-pendente';
                    if (authorizationStatus === 'Autorizado') {
                        authorizationBadgeClass = 'status-autorizado';
                    } else if (authorizationStatus === 'Não Autorizado') {
                        authorizationBadgeClass = 'status-nao-autorizado';
                    }

                    let actionButtons = `
                        <button data-id="${p.id}" class="edit-btn text-cyan-400 hover:text-cyan-300 mx-2" title="Editar" data-permission="edit_payment"><i class="fas fa-pencil-alt"></i></button>
                        <button data-id="${p.id}" class="delete-btn text-red-500 hover:text-red-400 mx-2" title="Excluir" data-permission="delete_payment"><i class="fas fa-trash-alt"></i></button>
                    `;

                    if (authorizationStatus === 'Pendente') {
                        actionButtons += `
                            <button data-id="${p.id}" class="authorize-btn text-green-500 hover:text-green-400 mx-2" title="Autorizar" data-permission="authorize_payment"><i class="fas fa-thumbs-up"></i></button>
                            <button data-id="${p.id}" class="deny-btn text-red-500 hover:text-red-400 mx-2" title="Não Autorizar" data-permission="authorize_payment"><i class="fas fa-thumbs-down"></i></button>
                        `;
                    }

                    if (authorizationStatus === 'Autorizado' && p.status === 'Pendente') {
                        actionButtons += `<button data-id="${p.id}" class="toggle-status-btn text-green-500 hover:text-green-400 mx-2" title="Marcar como Pago" data-permission="pay_payment"><i class="fas fa-check-circle"></i></button>`;
                    }

                    row.innerHTML = `
                        <td class="p-4 font-medium text-white">${p.description} ${p.attachment ? `<a href="${p.attachment}" target="_blank" class="text-cyan-400 hover:text-cyan-300" title="Ver Anexo"><i class="fas fa-paperclip ml-2"></i></a>` : ''}</td>
                        <td class="p-4">${tagHtml}</td>
                        <td class="p-4 font-medium text-white whitespace-nowrap">${this.formatCurrency(p.value)}</td>
                        <td class="p-4 whitespace-nowrap ${isOverdue ? 'text-overdue' : ''}">${this.formatDate(p.dueDate)}</td>
                        <td class="p-4 text-center"><span class="priority-badge priority-${p.priority.toLowerCase()}">${p.priority}</span></td>
                        <td class="p-4 text-center"><span class="status-badge ${p.status === 'Pago' ? 'status-pago' : 'status-pendente'}">${p.status}</span></td>
                        <td class="p-4 text-center"><span class="status-badge ${authorizationBadgeClass}">${authorizationStatus.replace(/_/g, ' ')}</span></td>
                        <td class="p-4 text-center whitespace-nowrap">${actionButtons}</td>
                    `;
                    this.ui.paymentTableBody.appendChild(row);
                });
                this.addTableEventListeners();
                this.checkPermissions();
            }

            async renderLoans() {
                if (!this.state.currentCompanyId) return;
                this.showLoader();
                const { data: loans, error: loansError } = await this.supabase.from('loans').select('*').eq('company_id', this.state.currentCompanyId).order('created_at');
                const { data: payments, error: paymentsError } = await this.supabase.from('payments').select('loan_id, status').eq('company_id', this.state.currentCompanyId);
                this.hideLoader();

                if (loansError || paymentsError) {
                    console.error('Erro ao buscar empréstimos ou pagamentos:', loansError || paymentsError);
                    this.ui.loansView.innerHTML = `<div class="lg:col-span-3 text-center p-12 text-slate-400"><p>Erro ao carregar empréstimos.</p></div>`;
                    return;
                }

                this.ui.loansView.innerHTML = '';
                if (loans.length === 0) {
                    this.ui.loansView.innerHTML = `<div class="lg:col-span-3 text-center p-12 text-slate-400">
                        <i class="fas fa-landmark fa-3x mb-4"></i>
                        <p class="font-semibold">Nenhum empréstimo registado.</p>
                    </div>`;
                    return;
                }

                loans.forEach(loan => {
                    const relatedPayments = payments.filter(p => p.loan_id === loan.id);
                    const paidCount = relatedPayments.filter(p => p.status === 'Pago').length;
                    const progress = (paidCount / loan.installments) * 100;
                    const totalFinanced = loan.total_amount + (loan.valor_iof_rs || 0) + (loan.valor_tac_rs || 0);
                    const installmentValue = totalFinanced / loan.installments;
                    const remainingAmount = (loan.installments - paidCount) * installmentValue;

                    const card = document.createElement('div');
                    card.className = 'bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg flex flex-col justify-between';
                    card.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start">
                                <h3 class="text-xl font-bold text-white mb-2">${loan.description}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="status-badge ${loan.status === 'Quitado' ? 'status-pago' : 'status-pendente'}">${loan.status}</span>
                                    <button data-id="${loan.id}" class="delete-loan-btn text-red-500 hover:text-red-400 text-lg" data-permission="delete_loan"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                            <p class="text-slate-400">Valor Total: ${this.formatCurrency(loan.total_amount)}</p>
                            <p class="text-slate-400">Saldo Devedor: ${this.formatCurrency(remainingAmount)}</p>
                            <div class="text-xs text-slate-500 mt-2">
                                <span>CET: ${loan.cet_am || 'N/A'}% a.m.</span> | 
                                <span>Juros: ${loan.juros_nominais_am || 'N/A'}% a.m.</span>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between items-center mb-1 text-sm">
                                <span class="text-slate-300">Progresso</span>
                                <span>${paidCount} / ${loan.installments} Parcelas</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-2.5">
                                <div class="bg-cyan-500 h-2.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    `;
                    this.ui.loansView.appendChild(card);
                });
                this.addLoanEventListeners();
                this.checkPermissions();
            }

            updateActiveTab() {
                this.ui.moduleTabs.querySelectorAll('.tab-btn').forEach(tab => tab.classList.toggle('active', tab.dataset.module === this.state.currentModule));
            }

            addTableEventListeners() {
                this.ui.paymentTableBody.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const id = parseInt(target.dataset.id);
                    const payment = this.state.allPayments.find(p => p.id === id);
                    
                    if (target.classList.contains('edit-btn')) {
                        if (payment) {
                            this.ui.modalTitle.textContent = 'Editar Pagamento';
                            this.ui.paymentId.value = payment.id;
                            this.ui.paymentForm.description.value = payment.description;
                            this.ui.paymentForm.value.value = parseFloat(payment.value).toFixed(2).replace('.', ',');
                            this.ui.paymentForm.date.value = payment.date;
                            this.ui.paymentForm.dueDate.value = payment.dueDate;
                            this.ui.paymentForm['payment-method'].value = payment.paymentMethod;
                            this.ui.paymentForm.module.value = payment.module;
                            this.ui.paymentForm.priority.value = payment.priority;
                            this.ui.paymentForm.status.value = payment.status;
                            this.ui.tagsSelect.value = payment.tag || '';
                            this.ui.recurringPaymentSection.style.display = 'none';
                            this.openModal('payment');
                        }
                    } else if (target.classList.contains('delete-btn')) {
                        this.state.actionToConfirm = async () => {
                            this.showLoader();
                            await this.logAction('Delete Payment', { paymentId: id, description: payment.description });
                            const { error } = await this.supabase.from('payments').delete().eq('id', id);
                            if (error) console.error("Erro ao excluir pagamento:", error);
                            this.applyFilters();
                        };
                        this.ui.confirmTitle.textContent = 'Confirmar Exclusão';
                        this.ui.confirmText.textContent = 'Tem a certeza que deseja excluir este pagamento? Esta ação não pode ser desfeita.';
                        this.ui.confirmModal.style.display = 'flex';
                    } else if (target.classList.contains('toggle-status-btn')) {
                         this.state.actionToConfirm = async () => {
                            this.showLoader();
                            await this.logAction('Mark as Paid', { paymentId: id, description: payment.description });
                            const { error } = await this.supabase.from('payments').update({ status: 'Pago' }).eq('id', id);
                            if (error) console.error("Erro ao marcar como pago:", error);
                            this.fetchPaginatedPayments();
                        };
                        this.ui.confirmTitle.textContent = 'Confirmar Pagamento';
                        this.ui.confirmText.textContent = 'Tem a certeza que deseja marcar este item como pago?';
                        this.ui.confirmModal.style.display = 'flex';
                    } else if (target.classList.contains('authorize-btn')) {
                        this.state.actionToConfirm = async () => {
                            this.showLoader();
                            await this.logAction('Authorize Payment', { paymentId: id, description: payment.description });
                            const { error } = await this.supabase.from('payments').update({ authorization_status: 'Autorizado' }).eq('id', id);
                            if (error) console.error("Erro ao autorizar pagamento:", error);
                            this.fetchPaginatedPayments();
                        };
                        this.ui.confirmTitle.textContent = 'Confirmar Autorização';
                        this.ui.confirmText.textContent = 'Tem a certeza que deseja autorizar este pagamento?';
                        this.ui.confirmModal.style.display = 'flex';
                    } else if (target.classList.contains('deny-btn')) {
                        this.state.actionToConfirm = async () => {
                            this.showLoader();
                            await this.logAction('Deny Payment', { paymentId: id, description: payment.description });
                            const { error } = await this.supabase.from('payments').update({ authorization_status: 'Não Autorizado' }).eq('id', id);
                            if (error) console.error("Erro ao não autorizar pagamento:", error);
                            this.fetchPaginatedPayments();
                        };
                        this.ui.confirmTitle.textContent = 'Confirmar Rejeição';
                        this.ui.confirmText.textContent = 'Tem a certeza que deseja não autorizar este pagamento?';
                        this.ui.confirmModal.style.display = 'flex';
                    }
                });
            }

            addLoanEventListeners() {
                this.ui.loansView.addEventListener('click', (e) => {
                    const target = e.target.closest('.delete-loan-btn');
                    if (!target) return;

                    const id = parseInt(target.dataset.id);
                    this.state.actionToConfirm = async () => {
                        this.showLoader();
                        await this.logAction('Delete Loan', { loanId: id });
                        const { error: paymentsError } = await this.supabase.from('payments').delete().eq('loan_id', id);
                        if (paymentsError) console.error("Erro ao excluir parcelas:", paymentsError);
                        const { error: loanError } = await this.supabase.from('loans').delete().eq('id', id);
                        if (loanError) console.error("Erro ao excluir empréstimo:", loanError);
                        this.applyFilters();
                    };
                    this.ui.confirmTitle.textContent = 'Confirmar Exclusão de Empréstimo';
                    this.ui.confirmText.textContent = 'Tem a certeza que deseja excluir este empréstimo e todas as suas parcelas?';
                    this.ui.confirmModal.style.display = 'flex';
                });
            }
            
            renderAdminPanel() {
                this.ui.userList.innerHTML = '';
                this.state.staticUsers.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 bg-slate-700 rounded';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = user.username;
                    div.appendChild(nameSpan);

                    const buttonsDiv = document.createElement('div');
                    
                    const managePermissionsBtn = document.createElement('button');
                    managePermissionsBtn.innerHTML = '<i class="fas fa-cog"></i>';
                    managePermissionsBtn.className = 'text-cyan-400 hover:text-cyan-300 mx-2';
                    managePermissionsBtn.title = 'Gerir Permissões';
                    managePermissionsBtn.onclick = () => this.openPermissionsModal(user.username);
                    buttonsDiv.appendChild(managePermissionsBtn);

                    const manageWhatsAppBtn = document.createElement('button');
                    manageWhatsAppBtn.innerHTML = '<i class="fab fa-whatsapp"></i>';
                    manageWhatsAppBtn.className = 'text-green-400 hover:text-green-300 mx-2';
                    manageWhatsAppBtn.title = 'Gerir Notificações WhatsApp';
                    manageWhatsAppBtn.onclick = () => this.openWhatsAppModal(user.username);
                    buttonsDiv.appendChild(manageWhatsAppBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.className = 'text-red-500 hover:text-red-400 mx-2';
                    deleteBtn.title = 'Excluir Utilizador';
                    deleteBtn.onclick = () => {
                         this.state.actionToConfirm = async () => {
                            this.showLoader();
                            await this.logAction('Delete User', { deletedUsername: user.username });
                            const { error } = await this.supabase.from('static_users').delete().eq('username', user.username);
                            if (error) console.error("Erro ao excluir utilizador:", error);
                            await this.loadStaticUsers();
                            this.renderAdminPanel();
                            this.hideLoader();
                        };
                        this.ui.confirmTitle.textContent = 'Confirmar Exclusão';
                        this.ui.confirmText.textContent = `Tem a certeza que deseja excluir o utilizador "${user.username}"?`;
                        this.ui.confirmModal.style.display = 'flex';
                    };
                    buttonsDiv.appendChild(deleteBtn);

                    div.appendChild(buttonsDiv);
                    this.ui.userList.appendChild(div);
                });
            }
            
            openPermissionsModal(username) {
                const user = this.state.staticUsers.find(u => u.username === username);
                if (!user) return;

                this.ui.userPermissionsTitle.textContent = `Gerir Permissões: ${username}`;
                this.ui.permissionUsername.value = username;

                this.ui.permissionsCompanyList.innerHTML = '';
                this.state.allSystemCompanies.forEach(company => {
                    const id = `perm-company-${company.id}`;
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-3 text-slate-300 cursor-pointer';
                    label.htmlFor = id;
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = id;
                    checkbox.value = company.id;
                    checkbox.checked = user.companies.includes(company.id);
                    checkbox.className = 'w-4 h-4 bg-slate-700 border-slate-600 rounded text-cyan-500 focus:ring-cyan-500';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = company.name;

                    label.appendChild(checkbox);
                    label.appendChild(nameSpan);
                    this.ui.permissionsCompanyList.appendChild(label);
                });

                const permissionDetails = {
                    'Pagamentos': {
                        'create_payment': { title: 'Criar Pagamento', description: 'Permite ao utilizador registar novas contas a pagar.' },
                        'edit_payment': { title: 'Editar Pagamento', description: 'Permite ao utilizador modificar informações de pagamentos existentes.' },
                        'delete_payment': { title: 'Excluir Pagamento', description: 'Permite ao utilizador remover permanentemente um registo de pagamento.' },
                        'authorize_payment': { title: 'Autorizar Pagamento', description: 'Permite ao utilizador aprovar ou rejeitar um pagamento pendente.' },
                        'pay_payment': { title: 'Efetuar Pagamento', description: 'Permite ao utilizador marcar um pagamento autorizado como "Pago".' },
                    },
                    'Empréstimos': {
                        'create_loan': { title: 'Criar Empréstimo', description: 'Permite ao utilizador registar novos empréstimos e gerar as suas parcelas.' },
                        'delete_loan': { title: 'Excluir Empréstimo', description: 'Permite ao utilizador remover um empréstimo e todas as suas parcelas.' },
                    },
                    'Geral': {
                        'manage_tags': { title: 'Gerir Tags', description: 'Permite ao utilizador criar e excluir tags para organizar os pagamentos.' },
                    }
                };

                this.ui.permissionsActionList.innerHTML = '';
                for (const groupName in permissionDetails) {
                    const groupTitle = document.createElement('h4');
                    groupTitle.className = 'text-md font-semibold text-slate-300 mt-4 mb-2';
                    groupTitle.textContent = groupName;
                    this.ui.permissionsActionList.appendChild(groupTitle);

                    const groupPermissions = permissionDetails[groupName];
                    for (const permKey in groupPermissions) {
                        const permInfo = groupPermissions[permKey];
                        const id = `perm-action-${permKey}`;

                        const container = document.createElement('div');
                        container.className = 'flex items-start space-x-3 p-3 bg-slate-700/50 rounded-lg';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = id;
                        checkbox.value = permKey;
                        checkbox.checked = user.permissions.includes(permKey);
                        checkbox.className = 'w-4 h-4 bg-slate-600 border-slate-500 rounded text-cyan-500 focus:ring-cyan-500 mt-1 flex-shrink-0';
                        
                        const textContainer = document.createElement('div');
                        
                        const label = document.createElement('label');
                        label.htmlFor = id;
                        label.className = 'font-semibold text-slate-200 cursor-pointer';
                        label.textContent = permInfo.title;

                        const description = document.createElement('p');
                        description.className = 'text-sm text-slate-400';
                        description.textContent = permInfo.description;

                        textContainer.appendChild(label);
                        textContainer.appendChild(description);
                        container.appendChild(checkbox);
                        container.appendChild(textContainer);
                        this.ui.permissionsActionList.appendChild(container);
                    }
                }

                this.ui.userPermissionsModal.style.display = 'flex';
            }
            
            openWhatsAppModal(username) {
                const user = this.state.staticUsers.find(u => u.username === username);
                if (!user) return;

                this.ui.whatsappNotificationsTitle.textContent = `Notificações para: ${username}`;
                this.ui.whatsappUsername.value = username;

                this.ui.whatsappNumber.value = user.whatsapp_number || '';
                this.ui.whatsappNotifyUpcoming.checked = user.whatsapp_notifications?.includes('upcoming') || false;
                this.ui.whatsappNotifyOverdue.checked = user.whatsapp_notifications?.includes('overdue') || false;

                this.ui.whatsappNotificationsModal.style.display = 'flex';
            }

            async fetchAllFilteredDataForExport() {
                if (!this.state.currentCompanyId) return [];
                this.showLoader();
                let query = this.supabase.from('payments').select('*').eq('company_id', this.state.currentCompanyId);

                if (this.state.currentModule === 'PAGO') {
                    query = query.eq('status', 'Pago');
                } else if (this.state.currentModule === 'CONTAS A PAGAR') {
                    query = query.eq('status', 'Pendente');
                } else if (this.state.currentModule !== 'DASHBOARD' && this.state.currentModule !== 'EMPRESTIMOS' && this.state.currentModule !== 'ADMIN') {
                    query = query.eq('module', this.state.currentModule);
                }

                if (this.state.searchTerm) query = query.ilike('description', `%${this.state.searchTerm}%`);
                if (this.state.selectedPriority !== 'all') query = query.eq('priority', this.state.selectedPriority);
                if (this.state.selectedPaymentMethod !== 'all') query = query.eq('paymentMethod', this.state.selectedPaymentMethod);
                if (this.state.selectedTag !== 'all') query = query.eq('tag', this.state.selectedTag);
                
                // CORREÇÃO: Lógica de filtro de data ajustada para usar 'dueDate'
                if (this.state.selectedYear !== 'all') {
                    if (this.state.selectedMonth !== 'all') {
                        const monthStartDate = new Date(this.state.selectedYear, this.state.selectedMonth, 1).toISOString().slice(0,10);
                        const monthEndDate = new Date(this.state.selectedYear, parseInt(this.state.selectedMonth) + 1, 0).toISOString().slice(0,10);
                        query = query.gte('dueDate', monthStartDate).lte('dueDate', monthEndDate);
                    } else {
                        const startDate = `${this.state.selectedYear}-01-01`;
                        const endDate = `${this.state.selectedYear}-12-31`;
                        query = query.gte('dueDate', startDate).lte('dueDate', endDate);
                    }
                }
                
                query = query.order('dueDate', { ascending: true });
                const { data, error } = await query;
                this.hideLoader();

                if (error) {
                    console.error('Erro ao buscar dados para exportação:', error);
                    return [];
                }
                return data;
            }

            async exportToCSV() {
                await this.logAction('Export to CSV');
                const payments = await this.fetchAllFilteredDataForExport();
                if (payments.length === 0) {
                    // Use a custom modal in a real app
                    alert('Nenhum dado para exportar com os filtros atuais.');
                    return;
                }

                const headers = [
                    'ID', 'Descricao', 'Valor', 'Data Lancamento', 'Data Vencimento', 
                    'Modulo', 'Prioridade', 'Status', 'Status Autorizacao', 
                    'Metodo Pagamento', 'Tag', 'ID Emprestimo'
                ];
                
                const csvRows = [headers.join(',')];

                for (const p of payments) {
                    const values = [
                        p.id,
                        `"${(p.description || '').replace(/"/g, '""')}"`,
                        p.value,
                        p.date,
                        p.dueDate,
                        p.module,
                        p.priority,
                        p.status,
                        p.authorization_status || 'Pendente',
                        p.paymentMethod || '',
                        p.tag || '',
                        p.loan_id || ''
                    ];
                    csvRows.push(values.join(','));
                }

                const csvString = csvRows.join('\n');
                const blob = new Blob([`\uFEFF${csvString}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'exportacao_pagamentos.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
            
            async exportToPDF() {
                await this.logAction('Export to PDF');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const payments = await this.fetchAllFilteredDataForExport();

                if (payments.length === 0) {
                    alert('Nenhum dado para exportar com os filtros atuais.');
                    return;
                }

                const companyName = this.ui.companySelector.options[this.ui.companySelector.selectedIndex].text;
                const title = `Relatório de Pagamentos - ${companyName}`;
                doc.text(title, 14, 16);

                const head = [['Descrição', 'Valor', 'Vencimento', 'Status', 'Módulo', 'Tag']];
                const body = payments.map(p => [
                    p.description,
                    this.formatCurrency(p.value),
                    this.formatDate(p.dueDate),
                    p.status,
                    p.module,
                    p.tag || 'N/A'
                ]);

                doc.autoTable({
                    head: head,
                    body: body,
                    startY: 22,
                    theme: 'grid',
                    styles: {
                        fontSize: 8
                    },
                    headStyles: {
                        fillColor: [15, 23, 42] // slate-900
                    }
                });

                doc.save('relatorio_pagamentos.pdf');
            }

            async logAction(action, details = {}) {
                try {
                    const logEntry = {
                        username: this.state.currentUser?.username || 'system',
                        action: action,
                        details: details,
                        company_id: this.state.currentCompanyId || null
                    };
                    const { error } = await this.supabase.from('audit_log').insert([logEntry]);
                    if (error) {
                        console.error('Error logging action:', error);
                    }
                } catch (err) {
                    console.error('Failed to log action:', err);
                }
            }

            async viewAuditLog() {
                this.showLoader();
                const selectedDate = this.ui.logDateFilter.value;
                if (!selectedDate) {
                    alert('Por favor, selecione uma data para ver o log.');
                    this.hideLoader();
                    return;
                }

                let query = this.supabase.from('audit_log')
                    .select('*')
                    .eq('company_id', this.state.currentCompanyId)
                    .order('created_at', { ascending: false });

                const startDate = `${selectedDate}T00:00:00.000Z`;
                const endDate = `${selectedDate}T23:59:59.999Z`;
                query = query.gte('created_at', startDate).lte('created_at', endDate);

                const { data, error } = await query;
                this.hideLoader();

                if (error) {
                    console.error('Error fetching audit log:', error);
                    alert('Falha ao carregar o log de atividades.');
                    return;
                }

                this.ui.auditLogContent.innerHTML = '';
                if (data.length === 0) {
                    this.ui.auditLogContent.innerHTML = '<p class="text-slate-400 text-center">Nenhuma atividade registada para esta data.</p>';
                } else {
                    data.forEach(log => {
                        const logDiv = document.createElement('div');
                        logDiv.className = 'p-3 mb-2 bg-slate-700/50 rounded-lg';
                        const detailsString = JSON.stringify(log.details, null, 2);
                        logDiv.innerHTML = `
                            <p class="font-semibold text-white">${log.action}</p>
                            <p class="text-sm text-slate-300">Utilizador: <span class="font-medium text-cyan-400">${log.username}</span></p>
                            <p class="text-sm text-slate-300">Data: ${this.formatDate(log.created_at, true)}</p>
                            <details class="mt-2 text-xs text-slate-400">
                                <summary class="cursor-pointer">Detalhes</summary>
                                <pre class="mt-1 p-2 bg-slate-900 rounded">${detailsString}</pre>
                            </details>
                        `;
                        this.ui.auditLogContent.appendChild(logDiv);
                    });
                }
                this.ui.auditLogModal.style.display = 'flex';
            }

            async generateBackup() {
                if (!this.state.currentCompanyId) {
                    alert('Por favor, selecione uma empresa primeiro.');
                    return;
                }
                this.showLoader();
                await this.logAction('Generate Backup');

                try {
                    const company = this.state.allSystemCompanies.find(c => c.id === this.state.currentCompanyId);
                    if (!company) throw new Error('Empresa não encontrada.');

                    const tablesToBackup = ['payments', 'loans', 'tags'];
                    const backupData = {};

                    for (const tableName of tablesToBackup) {
                        const { data, error } = await this.supabase
                            .from(tableName)
                            .select('*')
                            .eq('company_id', this.state.currentCompanyId);
                        
                        if (error) throw new Error(`Erro ao fazer backup da tabela ${tableName}: ${error.message}`);
                        backupData[tableName] = data;
                    }

                    const jsonString = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const link = document.createElement('a');

                    const date = new Date().toISOString().slice(0, 10);
                    link.href = URL.createObjectURL(blob);
                    link.download = `backup-${company.name.replace(/\s+/g, '_')}-${date}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                } catch (error) {
                    console.error('Falha no backup:', error);
                    alert(`Falha no backup: ${error.message}`);
                } finally {
                    this.hideLoader();
                }
            }


            addEventListeners() {
                this.ui.logoutBtn.addEventListener('click', async () => {
                    await this.logAction('Logout');
                    location.reload();
                });
                
                this.ui.companySelector.addEventListener('change', (e) => {
                    this.state.currentCompanyId = parseInt(e.target.value);
                    this.applyFilters();
                });

                this.ui.moduleTabs.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-btn')) {
                        this.state.currentModule = e.target.dataset.module;
                        this.applyFilters();
                    }
                });

                [this.ui.yearFilter, this.ui.monthFilter, this.ui.searchInput, this.ui.priorityFilter, this.ui.paymentMethodFilter, this.ui.tagFilter].forEach(el => {
                    el.addEventListener('change', () => this.applyFilters());
                    if (el.tagName === 'INPUT') el.addEventListener('keyup', () => this.applyFilters());
                });

                this.ui.exportPdfBtn.addEventListener('click', () => this.exportToPDF());
                this.ui.exportCsvBtn.addEventListener('click', () => this.exportToCSV());
                this.ui.manageTagsBtn.addEventListener('click', () => this.ui.manageTagsModal.style.display = 'flex');
                this.ui.closeTagsModalBtn.addEventListener('click', () => this.ui.manageTagsModal.style.display = 'none');
                
                // --- Dropdown Logic ---
                this.ui.addBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.ui.notificationDropdown.classList.add('hidden');
                    this.ui.addDropdown.classList.toggle('hidden');
                });

                this.ui.notificationBell.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.ui.addDropdown.classList.add('hidden');
                    this.ui.notificationDropdown.classList.toggle('hidden');
                });

                window.addEventListener('click', () => {
                    this.ui.addDropdown.classList.add('hidden');
                    this.ui.notificationDropdown.classList.add('hidden');
                });

                this.ui.addPaymentBtn.addEventListener('click', () => {
                    this.ui.modalTitle.textContent = 'Adicionar Novo Pagamento';
                    const formModuleSelect = this.ui.paymentForm.module;
                    if (this.state.currentModule !== 'DASHBOARD' && this.state.currentModule !== 'CONTAS A PAGAR' && this.state.currentModule !== 'EMPRESTIMOS' && this.state.currentModule !== 'PAGO' && this.state.currentModule !== 'ADMIN') {
                        formModuleSelect.value = this.state.currentModule;
                    } else {
                        formModuleSelect.value = this.state.moduleNames[0];
                    }
                    const today = new Date().toISOString().split('T')[0];
                    this.ui.paymentForm.date.value = today;
                    this.ui.paymentForm.dueDate.value = today;
                    this.ui.recurringPaymentSection.style.display = 'block';
                    this.openModal('payment');
                });
                
                this.ui.addLoanBtn.addEventListener('click', () => this.openModal('loan'));
                this.ui.cancelLoanBtn.addEventListener('click', () => this.closeModal('loan'));
                this.ui.cancelBtn.addEventListener('click', () => this.closeModal('payment'));
                this.ui.paymentModal.addEventListener('click', (e) => { if (e.target === this.ui.paymentModal) this.closeModal('payment'); });
                this.ui.loanModal.addEventListener('click', (e) => { if (e.target === this.ui.loanModal) this.closeModal('loan'); });
                
                this.ui.recurringPaymentCheckbox.addEventListener('change', () => {
                    this.ui.installmentsContainer.classList.toggle('hidden', !this.ui.recurringPaymentCheckbox.checked);
                    if (!this.ui.recurringPaymentCheckbox.checked) {
                        this.ui.installments.value = '';
                    }
                });

                this.ui.cancelConfirmBtn.addEventListener('click', () => {
                    this.ui.confirmModal.style.display = 'none';
                    this.state.actionToConfirm = null;
                });

                this.ui.confirmBtn.addEventListener('click', async () => {
                    if (typeof this.state.actionToConfirm === 'function') {
                        await this.state.actionToConfirm();
                    }
                    this.ui.confirmModal.style.display = 'none';
                    this.state.actionToConfirm = null;
                });

                this.ui.addTagForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newTagName = this.ui.newTagName.value.trim();
                    if (newTagName && !this.state.allTags.some(t => t.name.toLowerCase() === newTagName.toLowerCase())) {
                        this.showLoader();
                        await this.logAction('Create Tag', { tagName: newTagName });
                        const { error } = await this.supabase.from('tags').insert([{ name: newTagName, company_id: this.state.currentCompanyId }]);
                        this.hideLoader();
                        if (error) console.error('Erro ao adicionar tag:', error);
                        else {
                            this.ui.newTagName.value = '';
                            this.fetchTags();
                        }
                    }
                });

                this.ui.paymentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    this.showLoader();
                    const formData = new FormData(this.ui.paymentForm);
                    const id = formData.get('payment-id');
                    const isRecurring = this.ui.recurringPaymentCheckbox.checked;
                    const numberOfInstallments = parseInt(this.ui.installments.value);
                    const attachmentFile = this.ui.paymentForm.attachment.files[0];
                    let attachmentUrl = id ? this.state.allPayments.find(p => p.id == id).attachment : null;

                    if (attachmentFile) {
                        const filePath = `${this.state.currentCompanyId}/${Date.now()}-${attachmentFile.name}`;
                        const { error: uploadError } = await this.supabase.storage.from('comprovativos').upload(filePath, attachmentFile);
                        if (uploadError) { console.error('Erro no upload do anexo:', uploadError); alert('Falha ao enviar o anexo.'); this.hideLoader(); return; }
                        const { data: urlData } = this.supabase.storage.from('comprovativos').getPublicUrl(filePath);
                        attachmentUrl = urlData.publicUrl;
                    }

                    if (id || !isRecurring || !numberOfInstallments || numberOfInstallments < 2) {
                        const paymentData = {
                            description: formData.get('description'),
                            value: this.parseCurrency(formData.get('value').toString()),
                            paymentMethod: formData.get('payment-method'),
                            module: formData.get('module'),
                            priority: formData.get('priority'),
                            status: formData.get('status'),
                            attachment: attachmentUrl,
                            tag: formData.get('tag') || null,
                            date: formData.get('date'),
                            dueDate: formData.get('dueDate'),
                            company_id: this.state.currentCompanyId
                        };
                        if (id) {
                            await this.logAction('Update Payment', { paymentId: id, ...paymentData });
                            const { error } = await this.supabase.from('payments').update(paymentData).eq('id', id);
                            if (error) console.error("Erro ao atualizar:", error);
                        } else {
                            paymentData.authorization_status = 'Pendente';
                            await this.logAction('Create Payment', paymentData);
                            const { error } = await this.supabase.from('payments').insert([paymentData]);
                            if (error) console.error("Erro ao inserir:", error);
                        }
                    } else {
                        const paymentsToInsert = [];
                        const baseDescription = formData.get('description');
                        const firstDueDate = new Date(formData.get('dueDate') + 'T00:00:00');
                        const rawValue = this.parseCurrency(formData.get('value').toString());

                        for (let i = 0; i < numberOfInstallments; i++) {
                            const currentDueDate = new Date(firstDueDate);
                            currentDueDate.setMonth(firstDueDate.getMonth() + i);

                            const paymentData = {
                                description: `${baseDescription} - Parcela ${i + 1}/${numberOfInstallments}`,
                                value: rawValue,
                                paymentMethod: formData.get('payment-method'),
                                module: formData.get('module'),
                                priority: formData.get('priority'),
                                status: formData.get('status'),
                                attachment: attachmentUrl,
                                tag: formData.get('tag') || null,
                                date: formData.get('date'),
                                dueDate: currentDueDate.toISOString().slice(0,10),
                                company_id: this.state.currentCompanyId,
                                authorization_status: 'Pendente'
                            };
                            paymentsToInsert.push(paymentData);
                        }
                        await this.logAction('Create Recurring Payment', { description: baseDescription, installments: numberOfInstallments });
                        const { error } = await this.supabase.from('payments').insert(paymentsToInsert);
                        if (error) console.error("Erro ao inserir pagamentos recorrentes:", error);
                    }
                    
                    this.closeModal('payment');
                    this.applyFilters();
                });

                this.ui.loanForm.addEventListener('submit', async(e) => {
                    e.preventDefault();
                    this.showLoader();
                    const description = this.ui.loanForm['loan-description'].value;
                    const totalAmount = this.parseCurrency(this.ui.loanForm['loan-amount'].value);
                    const installments = parseInt(this.ui.loanForm['loan-installments'].value);
                    const startDate = this.ui.loanForm['loan-start-date'].value;
                    const tag = this.ui.loanForm['loan-tag'].value || null;
                    const gracePeriod = parseInt(this.ui.loanForm['loan-grace-period'].value) || 0;
                    const iof = this.parseCurrency(this.ui.loanForm['loan-iof'].value) || 0;
                    const tac = this.parseCurrency(this.ui.loanForm['loan-tac'].value) || 0;
                    const cet = this.parseCurrency(this.ui.loanForm['loan-cet'].value) || 0;
                    const nominalInterest = this.parseCurrency(this.ui.loanForm['loan-nominal-interest'].value) || 0;
                    const otherCharges = this.parseCurrency(this.ui.loanForm['loan-other-charges'].value) || 0;

                    const loanDetails = { 
                        description, total_amount: totalAmount, installments, start_date: startDate, status: 'Ativo',
                        prazo_pagamento_meses: installments, carencia_meses: gracePeriod, valor_iof_rs: iof,
                        valor_tac_rs: tac, cet_am: cet, juros_nominais_am: nominalInterest, outros_encargos_am: otherCharges,
                        company_id: this.state.currentCompanyId
                    };
                    await this.logAction('Create Loan', loanDetails);
                    const { data: loanData, error: loanError } = await this.supabase
                        .from('loans')
                        .insert([loanDetails])
                        .select()
                        .single();

                    if (loanError) {
                        console.error('Erro ao criar empréstimo:', loanError);
                        this.hideLoader();
                        return;
                    }

                    const totalFinanced = totalAmount + iof + tac;
                    const installmentValue = totalFinanced / installments;
                    const paymentsToInsert = [];
                    let currentDueDate = new Date(startDate + 'T00:00:00');
                    currentDueDate.setMonth(currentDueDate.getMonth() + gracePeriod);

                    for (let i = 0; i < installments; i++) {
                        paymentsToInsert.push({
                            description: `${description} - Parcela ${i + 1}/${installments}`,
                            value: installmentValue,
                            date: new Date().toISOString().slice(0,10),
                            dueDate: currentDueDate.toISOString().slice(0,10),
                            status: 'Pendente',
                            module: 'EMPRESTIMOS',
                            priority: 'Alta',
                            loan_id: loanData.id,
                            tag: tag,
                            company_id: this.state.currentCompanyId,
                            authorization_status: 'Autorizado'
                        });
                        currentDueDate.setMonth(currentDueDate.getMonth() + 1);
                    }

                    const { error: paymentsError } = await this.supabase.from('payments').insert(paymentsToInsert);
                    if(paymentsError) console.error('Erro ao criar parcelas:', paymentsError);

                    this.closeModal('loan');
                    this.applyFilters();
                });

                this.ui.addCompanyForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newCompanyName = this.ui.newCompanyName.value.trim();
                    if (newCompanyName) {
                        this.showLoader();
                        await this.logAction('Create Company', { companyName: newCompanyName });
                        const { error } = await this.supabase.from('companies').insert([{ name: newCompanyName }]);
                        if (error) {
                            console.error('Erro ao criar empresa:', error);
                            alert('Falha ao criar empresa.');
                        } else {
                            this.ui.addCompanyForm.reset();
                            await this.populateCompanySelector();
                            this.renderAdminPanel();
                        }
                        this.hideLoader();
                    }
                });

                this.ui.addUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = this.ui.newUserUsername.value.trim();
                    const password = this.ui.newUserPassword.value;

                    if (username && password) {
                        this.showLoader();
                        await this.logAction('Create User', { newUsername: username });
                        const { error } = await this.supabase.from('static_users').insert({ 
                            username, 
                            password, 
                            companies: [], 
                            permissions: [] 
                        });

                        if (error) {
                             console.error('Erro ao criar utilizador:', error);
                            alert('Falha ao criar utilizador. O nome de utilizador já pode existir.');
                        } else {
                            this.ui.addUserForm.reset();
                            await this.loadStaticUsers();
                            this.renderAdminPanel();
                        }
                        this.hideLoader();
                    }
                });

                this.ui.userPermissionsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    this.showLoader();
                    const username = this.ui.permissionUsername.value;
                    const selectedCompanies = Array.from(this.ui.permissionsCompanyList.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
                    const selectedPermissions = Array.from(this.ui.permissionsActionList.querySelectorAll('input:checked')).map(cb => cb.value);

                    await this.logAction('Update Permissions', { targetUser: username, companies: selectedCompanies, permissions: selectedPermissions });
                    const { error } = await this.supabase.from('static_users')
                        .update({ companies: selectedCompanies, permissions: selectedPermissions })
                        .eq('username', username);

                    if (error) {
                        console.error('Erro ao salvar permissões:', error);
                        alert('Falha ao salvar permissões.');
                    } else {
                        await this.loadStaticUsers();
                        this.ui.userPermissionsModal.style.display = 'none';
                    }
                    this.hideLoader();
                });

                this.ui.cancelPermissionsBtn.addEventListener('click', () => {
                    this.ui.userPermissionsModal.style.display = 'none';
                });

                this.ui.cancelWhatsappNotificationsBtn.addEventListener('click', () => {
                    this.ui.whatsappNotificationsModal.style.display = 'none';
                });

                this.ui.whatsappNotificationsForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    this.showLoader();
                    const username = this.ui.whatsappUsername.value;
                    const whatsappNumber = this.ui.whatsappNumber.value.trim();
                    const notificationPrefs = [];
                    if (this.ui.whatsappNotifyUpcoming.checked) notificationPrefs.push('upcoming');
                    if (this.ui.whatsappNotifyOverdue.checked) notificationPrefs.push('overdue');
                    
                    await this.logAction('Update WhatsApp Notifications', { targetUser: username, number: whatsappNumber, preferences: notificationPrefs });
                    const { error } = await this.supabase.from('static_users')
                        .update({ 
                            whatsapp_number: whatsappNumber,
                            whatsapp_notifications: notificationPrefs
                        })
                        .eq('username', username);

                    if (error) {
                        console.error('Erro ao salvar configurações do WhatsApp:', error);
                        alert('Falha ao salvar configurações.');
                    } else {
                        await this.loadStaticUsers();
                        this.ui.whatsappNotificationsModal.style.display = 'none';
                    }
                    this.hideLoader();
                });

                this.ui.viewLogBtn.addEventListener('click', () => this.viewAuditLog());
                this.ui.closeAuditLogBtn.addEventListener('click', () => this.ui.auditLogModal.style.display = 'none');
                this.ui.auditLogModal.addEventListener('click', (e) => { if(e.target === this.ui.auditLogModal) this.ui.auditLogModal.style.display = 'none' });
                
                this.ui.generateBackupBtn.addEventListener('click', () => this.generateBackup());
            }
        }
    </script>
</body>
</html>
